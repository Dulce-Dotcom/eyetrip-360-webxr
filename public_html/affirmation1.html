<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affirmation Journey: Matrix Caracas Sphere | EyeTrip VR</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="EyeTrip VR">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EyeTrip VR">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" href="images/eyetripvr-icon.png">
    <link rel="apple-touch-icon" href="images/eyetripvr-icon.png">
    <link rel="stylesheet" href="css/eyetrip-style.css">
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7Y1YJBXJ2X"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7Y1YJBXJ2X', {
            'page_title': 'Affirmation Journey: Matrix Caracas Sphere | EyeTrip VR',
            'page_path': window.location.pathname
        });
        
        // VR Event Tracking Helper
        window.trackVREvent = function(action, label, value) {
            console.log('üìä Tracking:', action, label, value);
            gtag('event', action, {
                'event_category': 'VR_Engagement',
                'event_label': label,
                'value': value
            });
        };
    </script>
    
    <!-- Import map to resolve bare module specifiers -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.153.0/build/three.module.js",
            "three/": "https://unpkg.com/three@0.153.0/"
        }
    }
    </script>
    
    <!-- WebXR Polyfill for broader support - load first -->
    <script src="https://unpkg.com/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>
    <script>
        // Initialize WebXR polyfill immediately
        if (window.WebXRPolyfill) {
            console.log('WebXR Polyfill loaded and initialized');
        }
        
        // Browser compatibility check
        (function checkBrowserCompatibility() {
            const warnings = [];
            
            // Check WebGL support
            if (!window.WebGLRenderingContext) {
                warnings.push('WebGL is not supported');
            } else {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) {
                    warnings.push('WebGL context could not be created');
                }
            }
            
            // Check for basic ES6 support
            try {
                eval('const test = () => {};');
            } catch (e) {
                warnings.push('Modern JavaScript (ES6) is not supported');
            }
            
            if (warnings.length > 0) {
                console.error('Browser compatibility issues:', warnings);
                setTimeout(() => {
                    alert(
                        'Your browser may not fully support this VR experience.\\n\\n' +
                        'Issues detected:\\n‚Ä¢ ' + warnings.join('\\n‚Ä¢ ') + '\\n\\n' +
                        'Please use Chrome, Firefox, Edge, or Safari on a recent device for best results.'
                    );
                }, 1000);
            }
        })();
        
        // Set single video configuration
        sessionStorage.setItem('selectedVideo', 'assets/videos/processed/matrixCaracasSphere_1/matrixCaracasSphere_1_1080p.mp4');
        sessionStorage.setItem('selectedTitle', 'Affirmation Journey: Matrix Caracas Sphere');
        sessionStorage.setItem('isAffirmationMode', 'true'); // Flag for affirmation mode
        
        // FOR TESTING: Create mock affirmation data if none exists
        if (!sessionStorage.getItem('affirmationData')) {
            console.log('üß™ TEST MODE: Creating mock affirmation data for direct page testing');
            
            // Create a simple test audio file (sine wave beep)
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const duration = 3; // 3 seconds
            const sampleRate = audioContext.sampleRate;
            const numSamples = duration * sampleRate;
            const audioBuffer = audioContext.createBuffer(1, numSamples, sampleRate);
            const channelData = audioBuffer.getChannelData(0);
            
            // Generate a simple tone
            for (let i = 0; i < numSamples; i++) {
                channelData[i] = Math.sin(2 * Math.PI * 440 * i / sampleRate) * 0.3;
            }
            
            // Convert to WAV format and then to base64
            const wav = audioBufferToWav(audioBuffer);
            const blob = new Blob([wav], { type: 'audio/wav' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = function() {
                const base64Audio = reader.result;
                
                const mockData = {
                    responses: {
                        emotionalTone: 'calming',
                        currentMood: 'anxious',
                        focusArea: 'self-love'
                    },
                    affirmations: [{
                        id: 1,
                        text: "TEST: I am worthy of love and acceptance",
                        audioData: base64Audio,
                        playCount: 0
                    }],
                    fullAudio: {
                        audioData: base64Audio,
                        duration: 3
                    },
                    metadata: {
                        tone: 'calming',
                        mood: 'anxious',
                        focus: 'self-love',
                        generatedAt: new Date().toISOString(),
                        testMode: true
                    },
                    experience: {
                        id: 1,
                        title: 'Matrix Caracas',
                        videoSrc: 'assets/videos/processed/matrixCaracasSphere_1/matrixCaracasSphere_1_1080p.mp4'
                    },
                    timestamp: Date.now()
                };
                
                sessionStorage.setItem('affirmationData', JSON.stringify(mockData));
                console.log('‚úÖ Mock affirmation data created and stored');
            };
        }
        
        // Helper function to convert AudioBuffer to WAV
        function audioBufferToWav(buffer) {
            const length = buffer.length * buffer.numberOfChannels * 2 + 44;
            const arrayBuffer = new ArrayBuffer(length);
            const view = new DataView(arrayBuffer);
            const channels = [];
            let offset = 0;
            let pos = 0;
            
            // Write WAV header
            const setUint16 = (data) => { view.setUint16(pos, data, true); pos += 2; };
            const setUint32 = (data) => { view.setUint32(pos, data, true); pos += 4; };
            
            setUint32(0x46464952); // "RIFF"
            setUint32(length - 8); // file length - 8
            setUint32(0x45564157); // "WAVE"
            setUint32(0x20746d66); // "fmt " chunk
            setUint32(16); // length = 16
            setUint16(1); // PCM (uncompressed)
            setUint16(buffer.numberOfChannels);
            setUint32(buffer.sampleRate);
            setUint32(buffer.sampleRate * 2 * buffer.numberOfChannels); // avg. bytes/sec
            setUint16(buffer.numberOfChannels * 2); // block-align
            setUint16(16); // 16-bit
            setUint32(0x61746164); // "data" - chunk
            setUint32(length - pos - 4); // chunk length
            
            // Write interleaved data
            for (let i = 0; i < buffer.numberOfChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }
            
            while (pos < length) {
                for (let i = 0; i < buffer.numberOfChannels; i++) {
                    let sample = Math.max(-1, Math.min(1, channels[i][offset]));
                    sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(pos, sample, true);
                    pos += 2;
                }
                offset++;
            }
            
            return arrayBuffer;
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/material-ui.css">
    <link rel="stylesheet" href="css/app.css">
    <style>
        /* Gallery thumbnail hover effects */
        .gallery-thumb {
            transition: transform 0.25s ease, box-shadow 0.25s ease, filter 0.25s ease !important;
        }
        .gallery-thumb:hover {
            transform: scale(1.08) !important;
            box-shadow: 0 8px 24px rgba(25, 118, 210, 0.4), 0 0 20px rgba(205, 0, 255, 0.3) !important;
            filter: brightness(1.1) !important;
        }
        .gallery-item {
            transition: transform 0.25s ease !important;
        }
        .gallery-item:hover {
            transform: translateY(-4px) !important;
        }
    </style>
</head>
<body>
    <!-- Hamburger menu for video switching is now a child of the header -->
        <script>
        // Hamburger menu toggle
        document.addEventListener('DOMContentLoaded', function() {
            const menuButton = document.getElementById('menuButton');
            const videoList = document.getElementById('videoList');
            if (menuButton && videoList) {
                menuButton.addEventListener('click', function() {
                    videoList.style.display = videoList.style.display === 'block' ? 'none' : 'block';
                });
            }
            // Video switch buttons
            const videoButtons = document.querySelectorAll('.video-switch');
            videoButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const idx = parseInt(btn.getAttribute('data-index'));
                    if (window.panoramaPlayer && typeof window.panoramaPlayer.playVideoByIndex === 'function') {
                        window.panoramaPlayer.playVideoByIndex(idx);
                    }
                    videoList.style.display = 'none';
                });
            });
        });
        </script>
    <div id="container">
    <!-- Start Experience Overlay -->
        <!-- Removed Start Experience Overlay and logic -->
        <script>
        // Play button logic (ensure video/audio starts on play)
                document.addEventListener('DOMContentLoaded', function() {
                    const playBtn = document.getElementById('playBtn');
                            if (playBtn) {
                                playBtn.addEventListener('click', () => {
                                    if (window.sceneManager && typeof window.sceneManager.loadScene === 'function') {
                                        window.sceneManager.loadScene(0).then(() => {
                                            const video = window.panoramaPlayer && window.panoramaPlayer.video;
                                            if (video) {
                                                video.play().then(() => {
                                                    document.getElementById('audioMuteBtn').disabled = false;
                                                    document.getElementById('mainVolume').disabled = false;
                                                    console.log('[AUDIO] controls enabled after play');
                                                }).catch((err) => {
                                                    console.warn('[AUDIO] video play failed:', err);
                                                });
                                            }
                                        });
                                    }
                                });
                            }

                });
        // Audio controls (mute/unmute, volume) remain unchanged and work in desktop mode
        </script>
    <div id="videoProgressBar" style="position:fixed;top:0;left:0;width:100vw;height:6px;background:#eee;z-index:100000;display:none;">
            <div id="videoProgress" style="height:100%;width:0;background:#1976d2;transition:width 0.2s;"></div>
        </div>
        <div id="canvas-container"></div>
        
        <div class="md-ui-layer">
            <div class="md-top-bar" id="topBar">
                <button class="md-button" onclick="window.location.href='gallery.html'" style="margin-right: 8px;" title="Back to Gallery">
                    <span class="material-icons">arrow_back</span>
                </button>
                <div class="md-title" style="display: inline-flex; align-items: center; vertical-align: middle;">
                    <img src="images/eyetripimagesvr-wide.svg?v=2" alt="EyeTripVR" style="height: 40px; width: auto; filter: brightness(0) invert(1) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.6)); margin-right: 16px;">
                    <span>‚ú® Affirmation Journey</span>
                </div>
                    <div id="mainMenu" style="display: none; background: #222; color: #fff; border-radius: 4px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); position: absolute; left: 16px; min-width: 180px;">
                        <ul style="list-style: none; margin: 0; padding: 0;">
                            <li id="galleryMenu" class="main-menu-item">Change Scene</li>
                            <li id="aboutMenu" class="main-menu-item">About</li>
                            <li id="contactMenu" class="main-menu-item" style="border-bottom:none;">Contact</li>
                        </ul>
                        <style>
                        #mainMenu {
                            background: #23272f;
                            color: #fff;
                            border-radius: 12px;
                            margin-top: 12px;
                            box-shadow: 0 6px 24px rgba(0,0,0,0.25);
                            padding: 8px 0;
                            min-width: 200px;
                            font-family: 'Roboto', sans-serif;
                        }
                        #mainMenu ul {
                            padding: 0;
                            margin: 0;
                        }
                        .main-menu-item {
                            padding: 16px 32px;
                            border-bottom: 1px solid #353a45;
                            cursor: pointer;
                            font-size: 1.08em;
                            transition: background 0.18s, color 0.18s;
                            border-radius: 8px;
                            margin: 0 8px;
                        }
                        .main-menu-item:last-child {
                            border-bottom: none;
                        }
                        .main-menu-item:hover {
                            background: #1976d2;
                            color: #fff;
                            box-shadow: 0 2px 8px rgba(25,118,210,0.12);
                        }
                        </style>
                    </div>
                </div>
                <div class="md-title" style="display: inline-block; vertical-align: middle;">EyeTrip Images - 360¬∞ Experience</div>
                <button class="md-button" id="settingsBtn">
                    <span class="material-icons">settings</span>
                </button>
                <style>
                    #settingsBtn { display: none !important; }
                </style>
            </div>

            <div class="md-scene-selector hidden" id="sceneSelector">
                <!-- Scene items will be generated dynamically -->
            </div>

            <div class="md-controls" id="controls">
                <button class="md-button" id="prevBtn" style="visibility: hidden;">
                    <span class="material-icons">skip_previous</span>
                </button>
                <button class="md-button md-primary" id="playBtn">
                    <span class="material-icons">play_arrow</span>
                </button>
                <button class="md-button" id="nextBtn" style="visibility: hidden;">
                    <span class="material-icons">skip_next</span>
                </button>
                <!-- Audio controls start -->
                <button class="md-button" id="audioMuteBtn" title="Mute/Unmute" style="margin-left:16px;">
                    <span class="material-icons" id="audioMuteIcon">volume_up</span>
                </button>
                <input id="mainVolume" type="range" min="0" max="1" step="0.01" value="1" style="width:100px; vertical-align:middle; margin:0 8px;">
                <!-- Time display -->
                <div id="videoTime" style="color: white; font-size: 14px; margin: 0 16px; font-family: 'Roboto Mono', monospace; min-width: 100px; text-align: center;">0:00 / 0:00</div>
                <!-- Audio controls end -->
                <button class="md-button" id="fullscreenBtn">
                    <span class="material-icons">fullscreen</span>
                </button>
                <!-- Exit to Gallery Button -->
                <button class="control-btn md-button" id="exitBtn" title="Exit to Gallery (ESC)" style="margin-left: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <!-- Debug overlay for sphere/texture status -->
                <div id="debugOverlay" style="position:fixed;top:10px;right:10px;z-index:9999;background:#222;color:#fff;padding:8px;border-radius:4px;display:none;font-size:14px;"></div>
                <!-- VRButton from Three.js will be injected by PanoramaPlayer.js -->
            </div>

            <div class="md-vr-indicator" id="vrIndicator">
                VR Mode Active
            </div>

            <div class="md-loading" id="loadingOverlay">
                <div class="md-spinner"></div>
                <div>Initializing 360¬∞ Experience...</div>
            </div>

            <div class="webxr-badge" id="webxrBadge"></div>

            <button class="md-fab" id="fabBtn">
                <span class="material-icons">360</span>
            </button>
            <style>
                #fabBtn { display: none !important; }
            </style>
        </div>
            <!-- Gallery Modal -->
            <div class="modal" id="galleryModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:10001; align-items:center; justify-content:center;">
                <div style="background:#222; color:#fff; border-radius:16px; padding:32px; max-width:1000px; width:96vw; position:relative; box-shadow:0 8px 32px rgba(0,0,0,0.35); overflow-y:auto; max-height:90vh;">
                    <button class="modal-close" style="position:absolute; top:16px; right:16px; background:none; border:none; color:#fff; font-size:28px; cursor:pointer;">&times;</button>
                    <h2 style="margin-top:0; margin-bottom:24px; font-size:2em; font-weight:500; letter-spacing:0.02em;">Select Experience</h2>
                    <div class="gallery-grid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:18px; margin-bottom:24px;">
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video1.png" data-video="assets/videos/stumpy_rect_2_1_4ktest_isVR.mp4" data-index="0" alt="Video 1" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="0" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video2.png" data-video="assets/videos/stumpy_rect_2_1_4ktest.mp4" data-index="1" alt="Video 2" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="1" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video3.png" data-video="assets/videos/stumpy_rect_16_9_4ktest_isVR.mp4" data-index="2" alt="Video 3" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="2" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video4.png" data-video="assets/videos/stumpy_rect_16_9_4ktest_isVR.mp4" data-index="3" alt="Video 4" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="3" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                    </div>
                    <video id="galleryVideoPlayer" controls style="width:100%; border-radius:6px; display:none; background:#000;"></video>
                </div>
            </div>

            <!-- About Modal -->
            <div class="modal" id="aboutModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:10001; align-items:center; justify-content:center;">
                <div style="background:#222; color:#fff; border-radius:8px; padding:32px; max-width:500px; width:90vw; position:relative;">
                    <button class="modal-close" style="position:absolute; top:16px; right:16px; background:none; border:none; color:#fff; font-size:28px; cursor:pointer;">&times;</button>
                    <h2 style="margin-top:0;">About</h2>
                    <p style="font-size:1.1em; line-height:1.6;">Welcome to EyeTrip Images 360¬∞ Experience. Immerse yourself in a curated selection of panoramic videos and explore new perspectives. This is a placeholder for more information about the project, the creators, and the vision behind EyeTrip Images. Stay tuned for updates!</p>
                </div>
            </div>

            <!-- Contact Modal -->
            <div class="modal" id="contactModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:10001; align-items:center; justify-content:center;">
                <div style="background:#222; color:#fff; border-radius:8px; padding:32px; max-width:400px; width:90vw; position:relative;">
                    <button class="modal-close" style="position:absolute; top:16px; right:16px; background:none; border:none; color:#fff; font-size:28px; cursor:pointer;">&times;</button>
                    <h2 style="margin-top:0;">Contact</h2>
                    <form id="contactForm" style="display:flex; flex-direction:column; gap:16px;">
                        <input type="email" name="email" placeholder="Your email" required style="padding:10px; border-radius:4px; border:none; font-size:1em;">
                        <textarea name="message" placeholder="Your message" required style="padding:10px; border-radius:4px; border:none; font-size:1em; min-height:80px;"></textarea>
                        <button type="submit" style="background:#1976d2; color:#fff; border:none; border-radius:4px; padding:10px; font-size:1em; cursor:pointer;">Send</button>
                    </form>
                    <div id="contactSuccess" style="display:none; color:#4caf50; margin-top:12px;">Thank you! Your message has been sent.</div>
                </div>
            </div>
            <script>
            // Hamburger menu toggle and modal logic
            document.addEventListener('DOMContentLoaded', function() {
                const menuButton = document.getElementById('menuButton');
                const mainMenu = document.getElementById('mainMenu');
                
                if (menuButton && mainMenu) {
                    menuButton.addEventListener('click', function() {
                        mainMenu.style.display = mainMenu.style.display === 'block' ? 'none' : 'block';
                    });
                }
                
                // Modal triggers
                const galleryMenu = document.getElementById('galleryMenu');
                const aboutMenu = document.getElementById('aboutMenu');
                const contactMenu = document.getElementById('contactMenu');
                
                if (galleryMenu) {
                    galleryMenu.onclick = function() {
                        if (mainMenu) mainMenu.style.display = 'none';
                        const modal = document.getElementById('galleryModal');
                        if (modal) modal.style.display = 'flex';
                    };
                }
                
                if (aboutMenu) {
                    aboutMenu.onclick = function() {
                        if (mainMenu) mainMenu.style.display = 'none';
                        const modal = document.getElementById('aboutModal');
                        if (modal) modal.style.display = 'flex';
                    };
                }
                
                if (contactMenu) {
                    contactMenu.onclick = function() {
                        if (mainMenu) mainMenu.style.display = 'none';
                        const modal = document.getElementById('contactModal');
                        if (modal) modal.style.display = 'flex';
                    };
                }
                // Modal close logic
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.onclick = function() {
                        btn.closest('.modal').style.display = 'none';
                        if (btn.closest('.modal').id === 'galleryModal') {
                            document.getElementById('galleryVideoPlayer').pause();
                            document.getElementById('galleryVideoPlayer').style.display = 'none';
                        }
                    };
                });
                // Gallery video click
                document.querySelectorAll('.gallery-thumb').forEach(thumb => {
                    thumb.onclick = function() {
                        const videoSrc = thumb.getAttribute('data-video');
                        const player = document.getElementById('galleryVideoPlayer');
                        player.pause();
                        player.currentTime = 0;
                        player.src = videoSrc;
                        player.style.display = 'block';
                        player.muted = false;
                        player.volume = 1;
                        player.play();
                    };
                });
                // Play in Experience buttons
                document.querySelectorAll('.play-experience-btn').forEach(btn => {
                    btn.onclick = function(e) {
                        const idx = parseInt(btn.getAttribute('data-index'));
                        // Reset gallery preview
                        const galleryPlayer = document.getElementById('galleryVideoPlayer');
                        galleryPlayer.pause();
                        galleryPlayer.currentTime = 0;
                        galleryPlayer.src = '';
                        galleryPlayer.style.display = 'none';
                        // Play video on sphere
                        if (window.panoramaPlayer && typeof window.panoramaPlayer.playVideoByIndex === 'function') {
                            window.panoramaPlayer.playVideoByIndex(idx);
                        }
                        document.getElementById('galleryModal').style.display = 'none';
                    };
                });
                // Gallery audio controls
                const galleryPlayer = document.getElementById('galleryVideoPlayer');
                const galleryMuteBtn = document.getElementById('galleryMuteBtn');
                const galleryVolume = document.getElementById('galleryVolume');
                if (galleryMuteBtn && galleryPlayer) {
                    galleryMuteBtn.onclick = function() {
                        galleryPlayer.muted = !galleryPlayer.muted;
                        galleryMuteBtn.textContent = galleryPlayer.muted ? 'Unmute' : 'Mute';
                    };
                }
                if (galleryVolume && galleryPlayer) {
                    galleryVolume.oninput = function() {
                        galleryPlayer.volume = parseFloat(galleryVolume.value);
                    };
                }
            });
            // Contact form submission (demo, no backend)
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('contactForm');
                if (form) {
                    form.onsubmit = function(e) {
                        e.preventDefault();
                        form.style.display = 'none';
                        document.getElementById('contactSuccess').style.display = 'block';
                    };
                }
            });
            // Main controls audio mute/unmute and volume
            // --- Main Experience Audio Controls ---
            const audioMuteBtn = document.getElementById('audioMuteBtn');
            const mainVolume = document.getElementById('mainVolume');
            const audioMuteIcon = document.getElementById('audioMuteIcon');

            function getCurrentVideo() {
                return window.panoramaPlayer && window.panoramaPlayer.video instanceof HTMLVideoElement ? window.panoramaPlayer.video : null;
            }

            function updateAudioControls() {
                const video = getCurrentVideo();
                if (video) {
                    mainVolume.disabled = false;
                    audioMuteBtn.disabled = false;
                    mainVolume.value = video.volume;
                    audioMuteIcon.textContent = video.muted ? 'volume_off' : 'volume_up';
                } else {
                    mainVolume.disabled = true;
                    audioMuteBtn.disabled = true;
                }
            }

            function attachAudioEvents(video) {
                if (!video) return;
                video.onvolumechange = updateAudioControls;
                video.onplay = updateAudioControls;
                video.onloadeddata = updateAudioControls;
            }

            function setAudioEventListeners() {
                // Remove previous listeners by re-assigning
                if (audioMuteBtn) {
                    audioMuteBtn.onclick = function() {
                        const video = getCurrentVideo();
                        if (video && !audioMuteBtn.disabled) {
                            video.muted = !video.muted;
                            audioMuteIcon.textContent = video.muted ? 'volume_off' : 'volume_up';
                            updateAudioControls();
                            console.log('[AUDIO] mute toggled:', video.muted);
                        } else {
                            console.warn('[AUDIO] mute button: no video element or control disabled');
                        }
                    };
                }
                if (mainVolume) {
                    mainVolume.oninput = function() {
                        const video = getCurrentVideo();
                        if (video && !mainVolume.disabled) {
                            video.volume = parseFloat(mainVolume.value);
                            updateAudioControls();
                            console.log('[AUDIO] volume set:', video.volume);
                        } else {
                            console.warn('[AUDIO] volume slider: no video element or control disabled');
                        }
                    };
                }
            }

            // Patch panoramaPlayer.loadVideo to always re-sync controls
            if (window.panoramaPlayer) {
                const origLoadVideo = window.panoramaPlayer.loadVideo;
                window.panoramaPlayer.loadVideo = function(url) {
                    const result = origLoadVideo.call(this, url);
                    setTimeout(function() {
                        const video = getCurrentVideo();
                        if (video) {
                            // Attach listeners and update controls immediately after loadeddata
                            video.addEventListener('loadeddata', function loadedHandler() {
                                attachAudioEvents(video);
                                setAudioEventListeners();
                                updateAudioControls();
                                video.removeEventListener('loadeddata', loadedHandler);
                                console.log('[AUDIO] controls enabled and synced after loadeddata');
                            });
                        } else {
                            mainVolume.disabled = true;
                            audioMuteBtn.disabled = true;
                        }
                        // Also run once in case loadeddata already fired
                        setAudioEventListeners();
                        updateAudioControls();
                        console.log('[AUDIO] controls updated after video load, video:', video);
                    }, 500);
                    return result;
                };
            }

            // Initial sync
            // Listen for custom event when main video is ready
            window.addEventListener('mainVideoReady', function() {
                const video = getCurrentVideo();
                console.log('[DEBUG] mainVideoReady event fired, getCurrentVideo:', video);
                attachAudioEvents(video);
                setAudioEventListeners();
                updateAudioControls();
                console.log('[AUDIO] controls enabled and synced after mainVideoReady event, video:', video);
                if (video) {
                    console.log('[DEBUG] video.muted:', video.muted, 'video.volume:', video.volume);
                } else {
                    console.warn('[DEBUG] No video element found in getCurrentVideo after mainVideoReady');
                }
            });
            </script>
    </div>

    <!-- Webpack will inject the correct bundled script automatically. -->
     <script type="module" src="js/app.js"></script>
    
    <!-- Affirmation System Integration -->
    <script type="module">
        import { AffirmationExporter } from './js/modules/AffirmationExporter.js';
        import { AffirmationSurvey } from './js/modules/AffirmationSurvey.js';
        import { ElevenLabsService } from './js/modules/ElevenLabsService.js';
        
        // Global affirmation state
        window.affirmationState = {
            exporter: null,
            generatedAffirmations: [],
            collectedAffirmations: [],
            userResponses: null,
            isInitialized: false,
            survey: null,
            elevenLabs: null
        };
        
        console.log('‚ú® Affirmation experience loading...');
        
        // Initialize services
        function initAffirmationServices() {
            window.affirmationState.survey = new AffirmationSurvey();
            window.affirmationState.elevenLabs = new ElevenLabsService();
            
            // Set up progress callback
            window.affirmationState.elevenLabs.setProgressCallback((message, percent) => {
                console.log(`üìä Progress: ${percent}% - ${message}`);
            });
            
            console.log('‚úÖ Affirmation services initialized');
        }
        
        // Check if we need to show survey
        function checkAffirmationData() {
            const testData = sessionStorage.getItem('affirmationData');
            
            if (testData) {
                console.log('‚úÖ Found affirmation data in sessionStorage');
                try {
                    const parsed = JSON.parse(testData);
                    console.log('üìä Data preview:', {
                        hasResponses: !!parsed.responses,
                        hasAffirmations: !!parsed.affirmations,
                        affirmationCount: parsed.affirmations?.length,
                        hasFullAudio: !!parsed.fullAudio
                    });
                    
                    // Data exists, load it properly first
                    loadAffirmationData();
                } catch (e) {
                    console.error('‚ùå Invalid JSON in sessionStorage:', e);
                    // Invalid data, start survey
                    startAffirmationSurvey();
                }
            } else {
                console.warn('‚ö†Ô∏è NO affirmation data - launching survey...');
                // No data, start survey
                startAffirmationSurvey();
            }
        }
        
        // Start affirmation survey
        function startAffirmationSurvey() {
            console.log('üéØ Starting affirmation survey...');
            
            initAffirmationServices();
            
            // Show survey with callback
            window.affirmationState.survey.show(async (responses, uiCallbacks) => {
                console.log('üìù Survey completed with responses:', responses);
                
                try {
                    // Update UI callbacks if provided
                    if (uiCallbacks) {
                        window.affirmationState.elevenLabs.setProgressCallback((message, percent) => {
                            console.log(`üìä Progress: ${percent}% - ${message}`);
                            uiCallbacks.updateProgress(message, percent);
                            
                            if (percent > 0 && percent < 30) {
                                uiCallbacks.updateApiStatus('Connecting...');
                            } else if (percent >= 30 && percent < 70) {
                                uiCallbacks.updateApiStatus('Generating...');
                            } else if (percent >= 70) {
                                uiCallbacks.updateApiStatus('Processing...');
                            }
                        });
                        
                        const cacheStats = window.affirmationState.elevenLabs.getCacheStats();
                        uiCallbacks.updateCacheStatus(cacheStats.size > 0 ? 'Hit!' : 'Miss');
                    }
                    
                    // Generate affirmations
                    console.log('üé§ Generating affirmations...');
                    const result = await window.affirmationState.elevenLabs.generateAffirmations(responses);
                    
                    console.log('‚úÖ Generation complete!', result);
                    
                    // Store in sessionStorage
                    const affirmationData = {
                        responses: responses,
                        affirmations: result.affirmations,
                        fullAudio: result.fullAudio,
                        metadata: result.metadata,
                        experience: {
                            id: Date.now(),
                            videoPath: sessionStorage.getItem('selectedVideo'),
                            videoTitle: sessionStorage.getItem('selectedTitle')
                        }
                    };
                    
                    sessionStorage.setItem('affirmationData', JSON.stringify(affirmationData));
                    console.log('üíæ Affirmation data saved to sessionStorage');
                    
                    // Hide survey
                    window.affirmationState.survey.hide();
                    
                    // Wait a moment, then load the data
                    setTimeout(() => {
                        waitForApp();
                    }, 500);
                    
                } catch (error) {
                    console.error('‚ùå Generation failed:', error);
                    alert(`Failed to generate affirmations: ${error.message}\\n\\nPlease try again or check your internet connection.`);
                    
                    // Hide survey so user can retry
                    window.affirmationState.survey.hide();
                }
            });
        }
        
        // Wait for app to be ready
        function waitForApp(data) {
            console.log('‚è≥ Waiting for app and hotspots...');
            
            // Use window.panoramaPlayer directly (set by PanoramaPlayer constructor)
            if (window.panoramaPlayer && window.panoramaPlayer.hotspotManager) {
                console.log('‚úÖ PanoramaPlayer ready, hotspotManager exists');
                // Wait a bit more for hotspots to be created
                setTimeout(() => {
                    if (window.panoramaPlayer.hotspotManager.hotspots && window.panoramaPlayer.hotspotManager.hotspots.length > 0) {
                        console.log(`‚úÖ Hotspots created (${window.panoramaPlayer.hotspotManager.hotspots.length} hotspots)`);
                        replaceHotspotSounds(data);
                        // Experience starts automatically - no "Begin Journey" message needed
                        console.log('‚úÖ Affirmations ready - experience starting automatically');
                    } else {
                        console.log('‚è≥ Hotspots not yet created, waiting...');
                        setTimeout(() => waitForApp(data), 500);
                    }
                }, 1000);
            } else {
                console.log('‚è≥ Waiting for panoramaPlayer.hotspotManager...');
                setTimeout(() => waitForApp(data), 500);
            }
        }
        
        // Load affirmation data from sessionStorage
        function loadAffirmationData() {
            console.log('üîç loadAffirmationData() called');
            console.log('   - isInitialized:', window.affirmationState.isInitialized);
            
            if (window.affirmationState.isInitialized) {
                console.log('‚è≠Ô∏è Already initialized, skipping');
                return;
            }
            
            // Get data from sessionStorage (set by gallery page)
            console.log('üìÇ Checking sessionStorage for affirmationData...');
            const storedData = sessionStorage.getItem('affirmationData');
            console.log('   - storedData exists:', !!storedData);
            console.log('   - storedData length:', storedData?.length || 0, 'characters');
            
            if (!storedData) {
                console.error('‚ùå No affirmation data found in sessionStorage!');
                console.log('üîç All sessionStorage keys:', Object.keys(sessionStorage));
                console.error('‚ùå Cannot proceed without affirmation data');
                alert('Please start your affirmation journey from the gallery page.');
                window.location.href = 'gallery.html';
                return;
            }
            
            try {
                console.log('üîÑ Parsing JSON data...');
                const data = JSON.parse(storedData);
                console.log('‚úÖ JSON parsed successfully');
                console.log('üì¶ Affirmation data structure:');
                console.log('   - responses:', data.responses);
                console.log('   - affirmations count:', data.affirmations?.length || 0);
                console.log('   - first affirmation has audioDataBase64:', !!data.affirmations?.[0]?.audioDataBase64);
                console.log('   - first affirmation base64 length:', data.affirmations?.[0]?.audioDataBase64?.length || 0);
                console.log('   - fullAudio has audioDataBase64:', !!data.fullAudio?.audioDataBase64);
                console.log('   - experience:', data.experience);
                console.log('   - metadata:', data.metadata);
                console.log('   - timestamp:', data.timestamp ? new Date(data.timestamp).toLocaleString() : 'N/A');
                
                // Validate data structure
                if (!data.affirmations || data.affirmations.length === 0) {
                    console.error('‚ùå No affirmations in data!');
                    throw new Error('Invalid affirmation data: no affirmations found');
                }
                
                if (!data.fullAudio || !data.fullAudio.audioDataBase64) {
                    console.error('‚ùå Full audio missing audioDataBase64 field!');
                    throw new Error('Invalid affirmation data: full audio missing');
                }
                
                // Convert full audio base64 to blob and create Audio element
                console.log('üîÑ Converting full audio base64 to Audio element...');
                
                const fullAudioBase64 = data.fullAudio.audioDataBase64;
                const base64Data = fullAudioBase64.includes(',') 
                    ? fullAudioBase64.split(',')[1] 
                    : fullAudioBase64;
                
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let j = 0; j < binaryString.length; j++) {
                    bytes[j] = binaryString.charCodeAt(j);
                }
                
                const audioBlob = new Blob([bytes], { type: 'audio/mpeg' });
                const fullAudioUrl = URL.createObjectURL(audioBlob);
                
                console.log(`   ‚úÖ Full audio: ${Math.round(audioBlob.size / 1024)}KB, duration: ${data.fullAudio.duration}s`);
                
                // Create Audio elements for each affirmation that play segments of the full audio
                console.log('üîÑ Creating audio segments for each affirmation...');
                
                for (let i = 0; i < data.affirmations.length; i++) {
                    const aff = data.affirmations[i];
                    
                    try {
                        // Create a NEW Audio element for each affirmation (not shared)
                        const audio = new Audio(fullAudioUrl);
                        // ALWAYS set volume to maximum for affirmations (force reset)
                        audio.volume = 1.0;
                        audio.loop = false;
                        audio.preload = 'auto';
                        
                        // Lock volume at 1.0 - prevent any external changes
                        Object.defineProperty(audio, 'volume', {
                            get: function() { return 1.0; },
                            set: function(val) { 
                                // Force volume to always be 1.0
                                HTMLMediaElement.prototype.__lookupSetter__('volume').call(this, 1.0);
                            }
                        });
                        
                        // Store segment info - minimal start delay, larger end trim
                        audio.segmentStart = aff.startTime + 0.05; // Start only 50ms after (reduced from 150ms)
                        audio.segmentEnd = aff.endTime - 0.4; // End 400ms before (increased from 300ms)
                        audio.isSegmentAudio = true;
                        
                        // Override play() to always start at segment beginning
                        const originalPlay = audio.play.bind(audio);
                        audio.play = async function() {
                            console.log(`‚ñ∂Ô∏è Playing segment ${aff.startTime.toFixed(2)}s - ${audio.segmentEnd.toFixed(2)}s`);
                            
                            // Wait for metadata to be loaded before seeking
                            if (this.readyState < 1) {
                                console.log('‚è≥ Waiting for metadata to load...');
                                await new Promise(resolve => {
                                    this.addEventListener('loadedmetadata', resolve, { once: true });
                                });
                            }
                            
                            // Now safe to set currentTime
                            this.currentTime = this.segmentStart;
                            return originalPlay();
                        };
                        
                        // Stop at segment end
                        audio.addEventListener('timeupdate', function() {
                            if (this.currentTime >= this.segmentEnd) {
                                console.log(`‚èπÔ∏è Reached segment end at ${this.currentTime.toFixed(2)}s, stopping`);
                                this.pause();
                                // Don't reset currentTime here - let play() handle it
                            }
                        });
                        
                        // Don't seek until play() is called - this prevents IndexSizeError
                        // The play() override above will handle seeking to segmentStart
                        
                        aff.audio = audio;
                        
                        console.log(`   ‚úÖ Affirmation ${aff.id}: Audio segment ${aff.startTime.toFixed(2)}s - ${audio.segmentEnd.toFixed(2)}s`);
                    } catch (audioError) {
                        console.error(`‚ùå Error creating audio for affirmation ${i}:`, audioError);
                        console.error('   Affirmation data:', aff);
                        throw audioError;
                    }
                }
                
                // Convert full audio for download
                if (data.fullAudio && data.fullAudio.audioDataBase64) {
                    const base64Data = data.fullAudio.audioDataBase64.includes(',')
                        ? data.fullAudio.audioDataBase64.split(',')[1]
                        : data.fullAudio.audioDataBase64;
                    
                    const binaryString = atob(base64Data);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let j = 0; j < binaryString.length; j++) {
                        bytes[j] = binaryString.charCodeAt(j);
                    }
                    
                    const blob = new Blob([bytes], { type: 'audio/wav' });
                    data.fullAudio.downloadUrl = URL.createObjectURL(blob);
                    data.fullAudio.blob = blob;
                    
                    console.log(`   ‚úÖ Full audio ready for download (${Math.round(blob.size / 1024)}KB)`);
                }
                
                // Store in global state
                window.affirmationState.userResponses = data.responses;
                window.affirmationState.generatedAffirmations = data.affirmations;
                window.affirmationState.fullAudioData = data.fullAudio;
                window.affirmationState.isInitialized = true;
                
                console.log('‚úÖ Affirmation data loaded and ready');
                console.log(`üìä ${data.affirmations.length} affirmation(s) with Audio elements`);
                
                // Wait for app and hotspots to be ready, then replace sounds
                waitForApp(data);
                
            } catch (error) {
                console.error('‚ùå Error loading affirmation data:', error);
                console.error('Stack trace:', error.stack);
                console.error('Error type:', error.constructor.name);
                console.error('Error message:', error.message);
                
                // More helpful error message
                const errorMsg = error.message.includes('audio') 
                    ? 'Error processing audio data. Please try generating affirmations again.'
                    : 'Error loading your affirmations. Please try again.';
                
                alert(errorMsg + '\n\nYou will be redirected to start over.');
                window.location.href = 'gallery.html';
            }
        }
        
        // Replace hotspot sounds with generated affirmations
        function replaceHotspotSounds(data) {
            console.log('üéØ ========================================');
            console.log('üéØ REPLACING HOTSPOT SOUNDS');
            console.log('üéØ ========================================');
            console.log('   - window.panoramaPlayer exists:', !!window.panoramaPlayer);
            console.log('   - window.panoramaPlayer.hotspotManager exists:', !!(window.panoramaPlayer && window.panoramaPlayer.hotspotManager));
            
            if (!window.panoramaPlayer || !window.panoramaPlayer.hotspotManager) {
                console.error('‚ùå HotspotManager not available, retrying in 500ms...');
                setTimeout(() => replaceHotspotSounds(data), 500);
                return;
            }
            
            const hotspots = window.panoramaPlayer.hotspotManager.hotspots;
            const affirmations = data.affirmations;
            
            console.log('   - hotspots array exists:', !!hotspots);
            console.log('   - hotspots.length:', hotspots?.length);
            console.log('   - affirmations.length:', affirmations?.length);
            
            // Wait for hotspots to be created
            if (!hotspots || hotspots.length === 0) {
                console.log('‚è≥ Hotspots not yet created (length=0), waiting 500ms...');
                setTimeout(() => replaceHotspotSounds(data), 500);
                return;
            }
            
            if (!affirmations || affirmations.length === 0) {
                console.error('‚ùå No affirmations to assign!');
                return;
            }
            
            // Replace the first N hotspots where N = number of affirmations
            const replaceCount = Math.min(hotspots.length, affirmations.length);
            console.log(`üìù Will replace ${replaceCount} hotspot(s) with affirmations`);
            console.log(`üìù Remaining ${hotspots.length - replaceCount} hotspot(s) will keep hunt sounds`);
            
            let successCount = 0;
            
            for (let i = 0; i < replaceCount; i++) {
                const hotspot = hotspots[i];
                const affirmation = affirmations[i];
                
                if (!affirmation.audio) {
                    console.error(`‚ùå Hotspot ${i}: Affirmation ${affirmation.id} has no audio element!`);
                    continue;
                }
                
                // Store original for debugging
                const originalSound = hotspot.sound;
                const originalLabel = hotspot.label;
                
                // REPLACE the audio element directly
                hotspot.audio = affirmation.audio;
                hotspot.isRegularAudio = true; // Flag that it's HTML5 Audio
                
                // Update the label to show FULL affirmation text (not truncated)
                hotspot.label = affirmation.text;
                
                // Store affirmation metadata
                hotspot.affirmationId = affirmation.id;
                hotspot.affirmationText = affirmation.text;
                hotspot.isAffirmation = true;
                
                console.log(`‚úÖ Hotspot ${i + 1}: Replaced sound and label`);
                console.log(`   - Original sound: ${originalSound}`);
                console.log(`   - Original label: ${originalLabel}`);
                console.log(`   - New label: "${hotspot.label}"`);
                console.log(`   - Audio ready: ${!!affirmation.audio}`);
                
                successCount++;
            }
            
            console.log('üéØ ========================================');
            console.log(`‚úÖ REPLACEMENT COMPLETE: ${successCount}/${replaceCount} successful`);
            console.log('üéØ ========================================');
            
            // Setup download UI when all affirmations found
            setupDownloadTracking(data);
        }
        
        // Setup download tracking
        function setupDownloadTracking(data) {
            console.log('üìä Setting up download tracking...');
            console.log(`   - Tracking ${data.affirmations.length} affirmation(s)`);
            
            // Track which affirmations have been found
            if (!window.affirmationState.foundAffirmations) {
                window.affirmationState.foundAffirmations = new Set();
            }
            
            // Listen for hotspot discovery
            const hotspotManager = window.panoramaPlayer.hotspotManager;
            if (hotspotManager) {
                // Store original callback if it exists
                const originalCallback = hotspotManager.onHotspotClick;
                
                // Override with our tracking
                hotspotManager.onHotspotClick = function(hotspot) {
                    // Call original if it exists
                    if (originalCallback) {
                        originalCallback.call(this, hotspot);
                    }
                    
                    // Track affirmation discovery
                    if (hotspot.isAffirmation && hotspot.affirmationId) {
                        window.affirmationState.foundAffirmations.add(hotspot.affirmationId);
                        
                        const foundCount = window.affirmationState.foundAffirmations.size;
                        const totalCount = data.affirmations.length;
                        
                        console.log(`‚úÖ Found affirmation ${hotspot.affirmationId}: ${foundCount}/${totalCount}`);
                        
                        // Check if all found
                        if (foundCount === totalCount) {
                            console.log('ÔøΩ All affirmations discovered!');
                            setTimeout(() => showDownloadUI(data), 2000);
                        }
                    }
                };
                
                console.log('‚úÖ Download tracking setup complete');
            } else {
                console.error('‚ùå Could not setup download tracking: hotspotManager not found');
            }
        }
        
        // Show download UI when all affirmations found
        function showDownloadUI(data) {
            console.log('üíæ ========================================');
            console.log('üíæ ALL AFFIRMATIONS FOUND!');
            console.log('üíæ Showing download UI...');
            console.log('üíæ ========================================');
            
            // Create download button
            const downloadBtn = document.createElement('button');
            downloadBtn.id = 'download-affirmations-btn';
            downloadBtn.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="white" style="margin-right: 8px;">
                    <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
                </svg>
                Download My Affirmations (${data.affirmations.length} tracks)
            `;
            downloadBtn.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: 2px solid rgba(255, 255, 255, 0.3);
                padding: 16px 32px;
                border-radius: 50px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                z-index: 10001;
                display: flex;
                align-items: center;
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
                animation: pulse 2s ease-in-out infinite;
                transition: all 0.3s ease;
            `;
            
            downloadBtn.addEventListener('mouseenter', () => {
                downloadBtn.style.transform = 'translateX(-50%) scale(1.05)';
                downloadBtn.style.boxShadow = '0 6px 30px rgba(102, 126, 234, 0.7)';
            });
            
            downloadBtn.addEventListener('mouseleave', () => {
                downloadBtn.style.transform = 'translateX(-50%) scale(1)';
                downloadBtn.style.boxShadow = '0 4px 20px rgba(102, 126, 234, 0.5)';
            });
            
            downloadBtn.addEventListener('click', () => {
                if (data.fullAudio && data.fullAudio.downloadUrl) {
                    console.log('üíæ Initiating download...');
                    console.log('   - URL:', data.fullAudio.downloadUrl.substring(0, 50) + '...');
                    console.log('   - Duration:', data.fullAudio.duration, 'seconds');
                    console.log('   - Size:', Math.round(data.fullAudio.blob?.size / 1024) || 'unknown', 'KB');
                    
                    const a = document.createElement('a');
                    a.href = data.fullAudio.downloadUrl;
                    a.download = `my-affirmations-${new Date().toISOString().split('T')[0]}.wav`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    console.log('‚úÖ Download started!');
                    
                    // Show success message
                    downloadBtn.innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white" style="margin-right: 8px;">
                            <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                        </svg>
                        Download Started!
                    `;
                    downloadBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    
                    setTimeout(() => {
                        downloadBtn.style.opacity = '0';
                        setTimeout(() => downloadBtn.remove(), 300);
                    }, 3000);
                } else {
                    console.error('‚ùå No download URL available');
                    console.log('   - fullAudio:', data.fullAudio);
                    alert('Sorry, unable to download affirmations. Please try again.');
                }
            });
            
            document.body.appendChild(downloadBtn);
            
            // Add pulse animation if not already in page
            if (!document.getElementById('download-pulse-style')) {
                const style = document.createElement('style');
                style.id = 'download-pulse-style';
                style.textContent = `
                    @keyframes pulse {
                        0%, 100% { transform: translateX(-50%) scale(1); }
                        50% { transform: translateX(-50%) scale(1.05); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            console.log('‚úÖ Download button added to page');
        }
        
        // Show ready message
        function showReadyMessage() {
            console.log('‚ú® Showing "Your Journey Awaits" message...');
            
            // CRITICAL: Stop/hide the default intro sequence if it exists
            if (window.app && window.app.player && window.app.player.introSequence) {
                console.log('üõë Hiding default intro sequence');
                window.app.player.introSequence.hide();
            }
            
            // CRITICAL: Pause the video if it's playing
            if (window.app && window.app.player && window.app.player.videoManager) {
                const video = window.app.player.videoManager.getCurrentVideo();
                if (video && !video.paused) {
                    console.log('‚è∏Ô∏è Pausing video until user clicks Begin Journey');
                    video.pause();
                }
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'affirmation-ready-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
                backdrop-filter: blur(30px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            const { emotionalTone, focusArea } = window.affirmationState.userResponses;
            
            overlay.innerHTML = `
                <div style="text-align: center; max-width: 700px; padding: 3rem;">
                    <div style="font-size: 5rem; margin-bottom: 1.5rem; animation: pulse 2s ease-in-out infinite;">‚ú®</div>
                    <h2 style="font-size: 2.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">
                        Your Journey Awaits
                    </h2>
                    <p style="color: rgba(255, 255, 255, 0.8); font-size: 1.2rem; line-height: 1.6; margin-bottom: 1.5rem;">
                        We've prepared <strong>10 personalized ${emotionalTone} affirmations</strong> focused on <strong>${focusArea}</strong>.
                    </p>
                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem;">
                        Discover the glowing hotspots in this immersive 360¬∞ experience to hear your unique messages.
                    </p>
                    <button id="begin-journey-btn"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 1.25rem 3rem; border-radius: 12px; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);">
                        Begin Journey ‚ú®
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Add click handler to start the experience
            const beginBtn = overlay.querySelector('#begin-journey-btn');
            beginBtn.onclick = function() {
                console.log('üöÄ User clicked Begin Journey - starting experience');
                
                // Remove overlay
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 300);
                
                // Start/resume the video
                if (window.app && window.app.player && window.app.player.videoManager) {
                    const video = window.app.player.videoManager.getCurrentVideo();
                    if (video) {
                        console.log('‚ñ∂Ô∏è Starting video playback');
                        video.play().catch(err => {
                            console.error('‚ùå Error playing video:', err);
                        });
                    }
                }
                
                // Track event
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'affirmation_journey_started', {
                        emotional_tone: window.affirmationState.userResponses.emotionalTone,
                        focus_area: window.affirmationState.userResponses.focusArea
                    });
                }
            };
            
            // Fade in
            setTimeout(() => overlay.style.opacity = '1', 10);
        }
        
        // Track hotspot discoveries with PLAY-TWICE logic
        if (window.app && window.app.hotspotManager) {
            const originalOnHotspotClick = window.app.hotspotManager.onHotspotClick;
            window.app.hotspotManager.onHotspotClick = function(hotspot) {
                // Check play-twice limit BEFORE playing
                if (hotspot.affirmationId !== undefined) {
                    const playCount = window.affirmationState.playCount[hotspot.affirmationId] || 0;
                    
                    if (playCount >= 2) {
                        console.log(`‚è≠Ô∏è Affirmation ${hotspot.affirmationId} already played 2 times - skipping`);
                        
                        // Show message to user
                        const msg = document.createElement('div');
                        msg.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: rgba(255, 100, 100, 0.9);
                            color: white;
                            padding: 1rem 2rem;
                            border-radius: 12px;
                            font-size: 1.1rem;
                            z-index: 9999;
                            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
                        `;
                        msg.textContent = 'This affirmation has already been heard twice ‚ú®';
                        document.body.appendChild(msg);
                        setTimeout(() => msg.remove(), 2000);
                        
                        return; // Don't play the sound
                    }
                    
                    // Increment play count
                    window.affirmationState.playCount[hotspot.affirmationId] = playCount + 1;
                    console.log(`‚ñ∂Ô∏è Playing affirmation ${hotspot.affirmationId} (${playCount + 1}/2)`);
                }
                
                // Call original handler (this will play the sound)
                if (originalOnHotspotClick) {
                    originalOnHotspotClick.call(this, hotspot);
                }
                
                // Track affirmation collection
                if (hotspot.affirmationIndex !== undefined) {
                    const affirmation = window.affirmationState.generatedAffirmations[hotspot.affirmationIndex];
                    if (affirmation && !window.affirmationState.collectedAffirmations.includes(affirmation)) {
                        window.affirmationState.collectedAffirmations.push(affirmation);
                        const collected = window.affirmationState.collectedAffirmations.length;
                        console.log(`‚úÖ Collected affirmation ${collected}/10`);
                        
                        // Show affirmation text overlay with play count
                        const playCount = window.affirmationState.playCount[hotspot.affirmationId];
                        showAffirmationOverlay(affirmation.text, playCount);
                        
                        // Check if all collected
                        if (collected === 10) {
                            setTimeout(() => {
                                showExportUI();
                            }, 3000);
                        }
                    } else if (affirmation) {
                        // Show overlay again for repeated play
                        const playCount = window.affirmationState.playCount[hotspot.affirmationId];
                        showAffirmationOverlay(affirmation.text, playCount);
                    }
                }
            };
        }
        
        // Show affirmation text overlay
        function showAffirmationOverlay(text, playCount) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(102, 126, 234, 0.95);
                color: white;
                padding: 1.5rem 2.5rem;
                border-radius: 16px;
                font-size: 1.2rem;
                max-width: 80%;
                text-align: center;
                z-index: 9998;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                animation: slideUpFade 0.5s ease;
            `;
            
            const playStatus = playCount ? ` [${playCount}/2]` : '';
            overlay.innerHTML = `
                <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;">${playStatus}</div>
                <div>"${text}"</div>
            `;
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                overlay.style.transform = 'translateX(-50%) translateY(-20px)';
                overlay.style.transition = 'all 0.5s ease';
                setTimeout(() => overlay.remove(), 500);
            }, 4000);
        }
        
        // Show export UI with instant download (full MP3 already created!)
        function showExportUI() {
            console.log('üéâ All affirmations collected! Preparing export...');
            
            // Get the full audio URL from sessionStorage
            const data = JSON.parse(sessionStorage.getItem('affirmationData'));
            const fullAudioUrl = data.fullAudio.url;
            const duration = data.fullAudio.duration;
            
            // Create export overlay
            const overlay = document.createElement('div');
            overlay.className = 'affirmation-export-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
                backdrop-filter: blur(30px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            overlay.innerHTML = `
                <div style="text-align: center; max-width: 600px; padding: 3rem; background: rgba(255, 255, 255, 0.05); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div style="font-size: 5rem; margin-bottom: 1.5rem;">üéâ</div>
                    <h2 style="font-size: 2.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">
                        Journey Complete!
                    </h2>
                    <p style="color: rgba(255, 255, 255, 0.8); font-size: 1.2rem; line-height: 1.6; margin-bottom: 2rem;">
                        You've discovered all <strong>10 affirmations</strong>. Your personalized audio (${Math.floor(duration)}s) is ready to download!
                    </p>
                    
                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 2rem;">
                        <button onclick="downloadFullAudio('${fullAudioUrl}')" 
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 1.25rem 2.5rem; border-radius: 12px; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);">
                            üíæ Download My Affirmations
                        </button>
                        <button onclick="window.location.href='gallery.html'" 
                                style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
                            ‚ú® Create New Journey
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            setTimeout(() => overlay.style.opacity = '1', 10);
        }
        
        // Download the full audio MP3 (already generated!)
        function downloadFullAudio(audioUrl) {
            console.log('üíæ Downloading full affirmation audio...');
            
            const a = document.createElement('a');
            a.href = audioUrl;
            a.download = `affirmations_${Date.now()}.mp3`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            console.log('‚úÖ Download initiated!');
        }
        
        // Start initialization when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkAffirmationData);
        } else {
            checkAffirmationData();
        }
        
        // CRITICAL: Log immediately on page load
        console.log('üöÄ ========================================');
        console.log('üöÄ AFFIRMATION1.HTML PAGE LOADED');
        console.log('üöÄ ========================================');
        console.log('üìÇ Checking sessionStorage immediately...');
        const immediateCheck = sessionStorage.getItem('affirmationData');
        console.log('   - sessionStorage.affirmationData exists:', !!immediateCheck);
        console.log('   - sessionStorage.affirmationData length:', immediateCheck?.length || 0);
        console.log('   - All sessionStorage keys:', Object.keys(sessionStorage));
        if (immediateCheck) {
            try {
                const parsed = JSON.parse(immediateCheck);
                console.log('‚úÖ Data found! Preview:', {
                    affirmationCount: parsed.affirmations?.length,
                    hasFullAudio: !!parsed.fullAudio,
                    timestamp: parsed.timestamp
                });
                
                // CRITICAL: Extract video path from experience data and set it BEFORE app.js uses it
                if (parsed.experience && parsed.experience.videoSrc) {
                    // Use path as-is from gallery (already correct for pages inside public_html/)
                    let videoPath = parsed.experience.videoSrc;
                    console.log('üé• Setting video path from experience data:', videoPath);
                    sessionStorage.setItem('selectedVideo', videoPath);
                    sessionStorage.setItem('selectedTitle', parsed.experience.title || 'Affirmation Journey');
                    console.log('   ‚úÖ Video path set in sessionStorage');
                } else {
                    console.warn('‚ö†Ô∏è No videoSrc in experience data, using default');
                }
            } catch (e) {
                console.error('‚ùå Invalid JSON:', e);
            }
        } else {
            console.error('‚ùå NO DATA IN SESSIONSTORAGE ON PAGE LOAD!');
            console.log('üîç This means either:');
            console.log('   1. Data was never stored on gallery page');
            console.log('   2. SessionStorage was cleared during navigation');
            console.log('   3. We are on a different domain/port');
        }
        console.log('üöÄ ========================================');
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ [PWA] Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.error('‚ùå [PWA] Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
