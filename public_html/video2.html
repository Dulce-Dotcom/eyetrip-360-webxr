<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraptangle | EyeTrip VR</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="EyeTrip VR">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EyeTrip VR">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    
    <!-- Performance: Preconnect to CDN -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- Performance: Preload critical CSS -->
    <link rel="preload" href="css/eyetrip-style.css" as="style">
    <link rel="preload" href="css/experience-mobile.css" as="style">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicons - Multiple sizes for all devices -->
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <link rel="stylesheet" href="css/eyetrip-style.css">
    <link rel="stylesheet" href="css/experience-mobile.css">
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7Y1YJBXJ2X"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7Y1YJBXJ2X', {
            'page_title': 'Scraptangle | EyeTrip VR',
            'page_path': window.location.pathname
        });
        
        // VR Event Tracking Helper
        window.trackVREvent = function(action, label, value) {
            console.log('üìä Tracking:', action, label, value);
            gtag('event', action, {
                'event_category': 'VR_Engagement',
                'event_label': label,
                'value': value
            });
        };
    </script>
    
    <!-- Import map to resolve bare module specifiers -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.170.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.170.0/examples/jsm/"
        }
    }
    </script>
    
    <!-- WebXR Polyfill for broader support - load first -->
    <script src="https://unpkg.com/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>
    <script>
        // Initialize WebXR polyfill - SKIP on Safari iOS to preserve WebGL contexts
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        if (window.WebXRPolyfill) {
            if (isIOS && isSafari) {
                console.log('üçé WebXR Polyfill SKIPPED on Safari iOS - preserving WebGL contexts');
                // Don't initialize polyfill on Safari iOS - it creates test contexts that exhaust the limit
                // Safari iOS 15+ has native WebXR support anyway
            } else {
                console.log('WebXR Polyfill loaded and initialized');
                new WebXRPolyfill();
            }
        }
        
        // Browser compatibility check
        (function checkBrowserCompatibility() {
            const warnings = [];
            
            // Check WebGL support - DON'T create context (Safari iOS has strict context limits)
            if (!window.WebGLRenderingContext) {
                warnings.push('WebGL is not supported');
            }
            // NOTE: Context creation test removed - Safari iOS loses contexts when multiple are created
            // The actual renderer will handle WebGL initialization
            
            // Check for basic ES6 support
            try {
                eval('const test = () => {};');
            } catch (e) {
                warnings.push('Modern JavaScript (ES6) is not supported');
            }
            
            if (warnings.length > 0) {
                console.error('Browser compatibility issues:', warnings);
                setTimeout(() => {
                    alert(
                        'Your browser may not fully support this VR experience.\\n\\n' +
                        'Issues detected:\\n‚Ä¢ ' + warnings.join('\\n‚Ä¢ ') + '\\n\\n' +
                        'Please use Chrome, Firefox, Edge, or Safari on a recent device for best results.'
                    );
                }, 1000);
            }
        })();
        
        // Set single video configuration
        sessionStorage.setItem('selectedVideo', 'assets/videos/processed/Scraptangle_latlong_05b_offsetOverture1/Scraptangle_latlong_05b_offsetOverture1_1080p.mp4');
        sessionStorage.setItem('selectedTitle', 'Scraptangle');
        sessionStorage.setItem('initialRotation', '90'); // Start facing left to show main content
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/material-ui.css?v=5">
    <link rel="stylesheet" href="css/app.css?v=103">
    <style>
        /* Gallery thumbnail hover effects */
        .gallery-thumb {
            transition: transform 0.25s ease, box-shadow 0.25s ease, filter 0.25s ease !important;
        }
        .gallery-thumb:hover {
            transform: scale(1.08) !important;
            box-shadow: 0 8px 24px rgba(25, 118, 210, 0.4), 0 0 20px rgba(205, 0, 255, 0.3) !important;
            filter: brightness(1.1) !important;
        }
        .gallery-item {
            transition: transform 0.25s ease !important;
        }
        .gallery-item:hover {
            transform: translateY(-4px) !important;
        }
    </style>
</head>
<body>
    <!-- Hamburger menu for video switching is now a child of the header -->
        <script>
        // Hamburger menu toggle
        document.addEventListener('DOMContentLoaded', function() {
            const menuButton = document.getElementById('menuButton');
            const videoList = document.getElementById('videoList');
            if (menuButton && videoList) {
                menuButton.addEventListener('click', function() {
                    videoList.style.display = videoList.style.display === 'block' ? 'none' : 'block';
                });
            }
            // Video switch buttons
            const videoButtons = document.querySelectorAll('.video-switch');
            videoButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const idx = parseInt(btn.getAttribute('data-index'));
                    if (window.panoramaPlayer && typeof window.panoramaPlayer.playVideoByIndex === 'function') {
                        window.panoramaPlayer.playVideoByIndex(idx);
                    }
                    videoList.style.display = 'none';
                });
            });
        });
        </script>
    <div id="container">
        <!-- Intro Overlay (first-time visitors only) -->
        <div id="introOverlay" class="intro-overlay" style="display: none;">
            <div class="intro-content">
                <h1>Scraptangle</h1>
                <p class="intro-subtitle">Navigate through a mesmerizing geometric landscape with spatial audio affirmations.</p>
                
                <div class="intro-grid">
                    <div class="intro-section">
                        <h3>ü•Ω VR Mode</h3>
                        <ul>
                            <li><strong>Look around</strong> - Glowing orbs appear at timed intervals</li>
                            <li><strong>Point + trigger</strong> to discover audio hotspots</li>
                            <li><strong>Press A button</strong> (or grip) for menu</li>
                        </ul>
                    </div>
                    
                    <div class="intro-section">
                        <h3>üñ•Ô∏è Desktop</h3>
                        <ul>
                            <li><strong>Click + drag</strong> to look around 360¬∞ space</li>
                            <li><strong>Click orbs</strong> to unlock spatial audio</li>
                            <li>Find all 10 hidden affirmations</li>
                        </ul>
                    </div>
                    
                    <div class="intro-section">
                        <h3>üì± Mobile</h3>
                        <ul>
                            <li><strong>Swipe</strong> to explore the 360¬∞ environment</li>
                            <li><strong>Tap orbs</strong> to discover affirmations</li>
                            <li>Use headphones for best audio</li>
                        </ul>
                    </div>
                    
                    <div class="intro-section accessibility-section">
                        <h3>‚ôø Accessibility</h3>
                        <div class="accessibility-options">
                            <label class="accessibility-option">
                                <input type="checkbox" id="reducedMotion" />
                                <span>Reduce motion</span>
                            </label>
                            <label class="accessibility-option">
                                <input type="checkbox" id="audioDescriptions" />
                                <span>Audio descriptions</span>
                            </label>
                            <label class="accessibility-option">
                                <input type="checkbox" id="highContrast" />
                                <span>High contrast</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <button id="startExperienceBtn" class="start-btn">Start Experience</button>
            </div>
        </div>
        
        <style>
            /* Intro Overlay Styles */
            .intro-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: url('assets/thumbnails/eyetrip-test-video2-optimized.jpg') center/cover no-repeat;
                z-index: 9998; /* Below loading overlay (9999) */
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                transition: opacity 0.3s ease;
                overflow: hidden;
            }
            
            .intro-overlay::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                z-index: 1;
            }
            
            .intro-overlay.visible {
                opacity: 1;
            }
            
            .intro-content {
                position: relative;
                z-index: 2;
                text-align: center;
                color: #f0f8ff;
                max-width: 900px;
                max-height: 85vh;
                width: 90%;
                padding: 20px 25px;
                background: rgba(27, 42, 65, 0.75);
                border-radius: 20px;
                box-shadow: 0 8px 32px rgba(205, 0, 255, 0.4);
                border: 2px solid rgba(240, 248, 255, 0.2);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                overflow-y: auto;
                animation: slideIn 0.5s ease-out;
                margin-top: 5vh;
            }
            
            @keyframes slideIn {
                from {
                    transform: translateY(20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            .intro-content h1 {
                font-size: 1.8rem;
                font-weight: 700;
                margin-bottom: 8px;
                color: #f0f8ff;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
                line-height: 1.2;
            }
            
            .intro-subtitle {
                font-size: 1rem;
                line-height: 1.4;
                margin-bottom: 15px;
                opacity: 0.95;
                color: rgba(240, 248, 255, 0.95);
            }
            
            .intro-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-bottom: 15px;
            }
            
            .intro-section {
                text-align: left;
                padding: 10px 12px;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 10px;
                border-left: 3px solid #00eeff;
            }
            
            .intro-section h3 {
                font-size: 0.95rem;
                margin-bottom: 6px;
                color: #00eeff;
                font-weight: 500;
            }
            
            .intro-section ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            
            .intro-section li {
                padding: 3px 0;
                font-size: 0.85rem;
                line-height: 1.4;
                color: rgba(240, 248, 255, 0.9);
            }
            
            .intro-section li strong {
                color: #fff;
                font-weight: 500;
            }
            
            .accessibility-section {
                border-left-color: #667eea;
            }
            
            .accessibility-section h3 {
                color: #667eea;
            }
            
            .accessibility-options {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            
            .accessibility-option {
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                padding: 5px;
                border-radius: 6px;
                transition: background 0.2s ease;
            }
            
            .accessibility-option:hover {
                background: rgba(102, 126, 234, 0.2);
            }
            
            .accessibility-option input[type="checkbox"] {
                width: 16px;
                height: 16px;
                cursor: pointer;
                accent-color: #667eea;
                flex-shrink: 0;
            }
            
            .accessibility-option span {
                font-size: 0.85rem;
                color: rgba(240, 248, 255, 0.9);
            }
            
            .start-btn {
                margin-top: 15px;
                padding: 12px 40px;
                font-size: 1.1rem;
                font-weight: 600;
                background: linear-gradient(45deg, #cd00ff, #00eeff);
                color: #fff;
                border: none;
                border-radius: 50px;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(205, 0, 255, 0.4);
                transition: all 0.3s ease;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            .start-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(205, 0, 255, 0.6);
            }
            
            .start-btn:active {
                transform: translateY(0);
            }
            
            /* Mobile optimizations */
            @media (max-width: 768px) {
                .intro-content {
                    max-width: 95%;
                    padding: 15px 18px;
                    max-height: 88vh;
                    margin-top: 6vh;
                }
                
                .intro-grid {
                    grid-template-columns: 1fr;
                    gap: 10px;
                }
                
                .intro-content h1 {
                    font-size: 1.4rem;
                }
                
                .intro-subtitle {
                    font-size: 0.9rem;
                }
                
                .intro-section {
                    padding: 8px 10px;
                }
                
                .intro-section h3 {
                    font-size: 0.9rem;
                }
                
                .intro-section li {
                    font-size: 0.8rem;
                }
                
                .accessibility-option span {
                    font-size: 0.8rem;
                }
                
                .start-btn {
                    padding: 10px 32px;
                    font-size: 1rem;
                }
            }
        </style>
        <script>
        // Play button logic (ensure video/audio starts on play)
                document.addEventListener('DOMContentLoaded', function() {
                    const playBtn = document.getElementById('playBtn');
                            if (playBtn) {
                                playBtn.addEventListener('click', () => {
                                    if (window.sceneManager && typeof window.sceneManager.loadScene === 'function') {
                                        window.sceneManager.loadScene(0).then(() => {
                                            const video = window.panoramaPlayer && window.panoramaPlayer.video;
                                            if (video) {
                                                video.play().then(() => {
                                                    document.getElementById('audioMuteBtn').disabled = false;
                                                    document.getElementById('mainVolume').disabled = false;
                                                    console.log('[AUDIO] controls enabled after play');
                                                }).catch((err) => {
                                                    console.warn('[AUDIO] video play failed:', err);
                                                });
                                            }
                                        });
                                    }
                                });
                            }

                });
        // Audio controls (mute/unmute, volume) remain unchanged and work in desktop mode
        </script>
    <div id="videoProgressBar" style="position:fixed;top:0;left:0;width:100vw;height:6px;background:#eee;z-index:100000;display:none;">
            <div id="videoProgress" style="height:100%;width:0;background:#1976d2;transition:width 0.2s;"></div>
        </div>
        <div id="canvas-container"></div>
        
        <div class="md-ui-layer">
            <div class="md-top-bar" id="topBar">
                <button class="md-button" onclick="window.location.href='gallery.html'" style="margin-right: 8px;" title="Back to Gallery">
                    <span class="material-icons">arrow_back</span>
                </button>
                <div class="md-title" style="display: inline-flex; align-items: center; vertical-align: middle;">
                    <img src="images/eyetripimagesvr-wide.svg?v=2" alt="EyeTripVR" style="height: 40px; width: auto; filter: brightness(0) invert(1) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.6)); margin-right: 16px;">
                    <span>Scraptangle</span>
                </div>
                    <div id="mainMenu" style="display: none; background: #222; color: #fff; border-radius: 4px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); position: absolute; left: 16px; min-width: 180px;">
                        <ul style="list-style: none; margin: 0; padding: 0;">
                            <li id="galleryMenu" class="main-menu-item">Change Scene</li>
                            <li id="aboutMenu" class="main-menu-item">About</li>
                            <li id="contactMenu" class="main-menu-item" style="border-bottom:none;">Contact</li>
                        </ul>
                        <style>
                        #mainMenu {
                            background: #23272f;
                            color: #fff;
                            border-radius: 12px;
                            margin-top: 12px;
                            box-shadow: 0 6px 24px rgba(0,0,0,0.25);
                            padding: 8px 0;
                            min-width: 200px;
                            font-family: 'Roboto', sans-serif;
                        }
                        #mainMenu ul {
                            padding: 0;
                            margin: 0;
                        }
                        .main-menu-item {
                            padding: 16px 32px;
                            border-bottom: 1px solid #353a45;
                            cursor: pointer;
                            font-size: 1.08em;
                            transition: background 0.18s, color 0.18s;
                            border-radius: 8px;
                            margin: 0 8px;
                        }
                        .main-menu-item:last-child {
                            border-bottom: none;
                        }
                        .main-menu-item:hover {
                            background: #1976d2;
                            color: #fff;
                            box-shadow: 0 2px 8px rgba(25,118,210,0.12);
                        }
                        </style>
                    </div>
                </div>
                <div class="md-title" style="display: inline-block; vertical-align: middle;">EyeTrip Images - 360¬∞ Experience</div>
                <button class="md-button" id="settingsBtn">
                    <span class="material-icons">settings</span>
                </button>
                <style>
                    #settingsBtn { display: none !important; }
                </style>
            </div>

            <div class="md-scene-selector hidden" id="sceneSelector">
                <!-- Scene items will be generated dynamically -->
            </div>

            <div class="md-controls" id="controls">
                <button class="md-button" id="prevBtn" style="visibility: hidden;">
                    <span class="material-icons">skip_previous</span>
                </button>
                <button class="md-button pulse-animation" id="playBtn" style="display: flex;">
                    <span class="material-icons">play_arrow</span>
                </button>
                <button class="md-button" id="nextBtn" style="visibility: hidden;">
                    <span class="material-icons">skip_next</span>
                </button>
                <!-- Audio controls start -->
                <button class="md-button" id="audioMuteBtn" title="Mute/Unmute" style="margin-left:16px;">
                    <span class="material-icons" id="audioMuteIcon">volume_up</span>
                </button>
                <input id="mainVolume" type="range" min="0" max="1" step="0.01" value="1" style="width:100px; vertical-align:middle; margin:0 8px;">
                <!-- Time display -->
                <div id="videoTime" style="color: white; font-size: 14px; margin: 0 16px; font-family: 'Roboto Mono', monospace; min-width: 100px; text-align: center;">0:00 / 0:00</div>
                <!-- Audio controls end -->
                <button class="md-button" id="fullscreenBtn">
                    <span class="material-icons">fullscreen</span>
                </button>
                <!-- Exit to Gallery Button -->
                <button class="control-btn md-button" id="exitBtn" title="Exit to Gallery (ESC)" style="margin-left: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <!-- Debug overlay for sphere/texture status -->
                <div id="debugOverlay" style="position:fixed;top:10px;right:10px;z-index:9999;background:#222;color:#fff;padding:8px;border-radius:4px;display:none;font-size:14px;"></div>
                <!-- VRButton from Three.js will be injected by PanoramaPlayer.js -->
            </div>

            <div class="md-vr-indicator" id="vrIndicator">
                VR Mode Active
            </div>

            <div class="md-loading" id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(27, 42, 65, 0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; color: white;">
                <div class="md-spinner" style="width: 80px; height: 80px; border: 8px solid rgba(255, 255, 255, 0.2); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 24px;"></div>
                <div style="font-size: 1.5em; font-weight: 500; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">Initializing 360¬∞ Experience...</div>
                <div style="font-size: 1em; margin-top: 16px; opacity: 0.9;">Scraptangle</div>
            </div>
            
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>

            <div id="webxrBadge">WebXR Ready</div>

            <script>
            // Auto-hide WebXR badge after 30 seconds, show on hover (desktop only)
            (function() {
                const badge = document.getElementById('webxrBadge');
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (badge && !isMobile) {
                    setTimeout(() => {
                        badge.style.opacity = '0';
                        badge.style.pointerEvents = 'none';
                    }, 30000); // 30 seconds
                    
                    // Show on hover over that area (desktop only)
                    badge.addEventListener('mouseenter', () => {
                        badge.style.opacity = '1';
                        badge.style.pointerEvents = 'auto';
                    });
                    
                    badge.addEventListener('mouseleave', () => {
                        badge.style.opacity = '0';
                        badge.style.pointerEvents = 'none';
                    });
                } else if (badge && isMobile) {
                    // Force hide on mobile immediately
                    badge.style.display = 'none';
                    badge.style.visibility = 'hidden';
                    badge.style.opacity = '0';
                }
            })();
            </script>

            <button class="md-fab" id="fabBtn">
                <span class="material-icons">360</span>
            </button>
            <style>
                #fabBtn { display: none !important; }
            </style>
        </div>
            <!-- Gallery Modal -->
            <div class="modal" id="galleryModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:10001; align-items:center; justify-content:center;">
                <div style="background:#222; color:#fff; border-radius:16px; padding:32px; max-width:1000px; width:96vw; position:relative; box-shadow:0 8px 32px rgba(0,0,0,0.35); overflow-y:auto; max-height:90vh;">
                    <button class="modal-close" style="position:absolute; top:16px; right:16px; background:none; border:none; color:#fff; font-size:28px; cursor:pointer;">&times;</button>
                    <h2 style="margin-top:0; margin-bottom:24px; font-size:2em; font-weight:500; letter-spacing:0.02em;">Select Experience</h2>
                    <div class="gallery-grid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:18px; margin-bottom:24px;">
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video1.png" data-video="assets/videos/stumpy_rect_2_1_4ktest_isVR.mp4" data-index="0" alt="Video 1" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="0" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video2.png" data-video="assets/videos/stumpy_rect_2_1_4ktest.mp4" data-index="1" alt="Video 2" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="1" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video3.png" data-video="assets/videos/stumpy_rect_16_9_4ktest_isVR.mp4" data-index="2" alt="Video 3" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="2" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video4.png" data-video="assets/videos/stumpy_rect_16_9_4ktest_isVR.mp4" data-index="3" alt="Video 4" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="3" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                    </div>
                    <video id="galleryVideoPlayer" controls style="width:100%; border-radius:6px; display:none; background:#000;"></video>
                </div>
            </div>

            <!-- About Modal -->
            <div class="modal" id="aboutModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:10001; align-items:center; justify-content:center;">
                <div style="background:#222; color:#fff; border-radius:8px; padding:32px; max-width:500px; width:90vw; position:relative;">
                    <button class="modal-close" style="position:absolute; top:16px; right:16px; background:none; border:none; color:#fff; font-size:28px; cursor:pointer;">&times;</button>
                    <h2 style="margin-top:0;">About</h2>
                    <p style="font-size:1.1em; line-height:1.6;">Welcome to EyeTrip Images 360¬∞ Experience. Immerse yourself in a curated selection of panoramic videos and explore new perspectives. This is a placeholder for more information about the project, the creators, and the vision behind EyeTrip Images. Stay tuned for updates!</p>
                </div>
            </div>

            <!-- Contact Modal -->
            <div class="modal" id="contactModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:10001; align-items:center; justify-content:center;">
                <div style="background:#222; color:#fff; border-radius:8px; padding:32px; max-width:400px; width:90vw; position:relative;">
                    <button class="modal-close" style="position:absolute; top:16px; right:16px; background:none; border:none; color:#fff; font-size:28px; cursor:pointer;">&times;</button>
                    <h2 style="margin-top:0;">Contact</h2>
                    <form id="contactForm" style="display:flex; flex-direction:column; gap:16px;">
                        <input type="email" name="email" placeholder="Your email" required style="padding:10px; border-radius:4px; border:none; font-size:1em;">
                        <textarea name="message" placeholder="Your message" required style="padding:10px; border-radius:4px; border:none; font-size:1em; min-height:80px;"></textarea>
                        <button type="submit" style="background:#1976d2; color:#fff; border:none; border-radius:4px; padding:10px; font-size:1em; cursor:pointer;">Send</button>
                    </form>
                    <div id="contactSuccess" style="display:none; color:#4caf50; margin-top:12px;">Thank you! Your message has been sent.</div>
                </div>
            </div>
            <script>
            // Hamburger menu toggle and modal logic
            document.addEventListener('DOMContentLoaded', function() {
                const menuButton = document.getElementById('menuButton');
                const mainMenu = document.getElementById('mainMenu');
                
                if (menuButton && mainMenu) {
                    menuButton.addEventListener('click', function() {
                        mainMenu.style.display = mainMenu.style.display === 'block' ? 'none' : 'block';
                    });
                }
                
                // Modal triggers
                const galleryMenu = document.getElementById('galleryMenu');
                const aboutMenu = document.getElementById('aboutMenu');
                const contactMenu = document.getElementById('contactMenu');
                
                if (galleryMenu) {
                    galleryMenu.onclick = function() {
                        if (mainMenu) mainMenu.style.display = 'none';
                        const modal = document.getElementById('galleryModal');
                        if (modal) modal.style.display = 'flex';
                    };
                }
                
                if (aboutMenu) {
                    aboutMenu.onclick = function() {
                        if (mainMenu) mainMenu.style.display = 'none';
                        const modal = document.getElementById('aboutModal');
                        if (modal) modal.style.display = 'flex';
                    };
                }
                
                if (contactMenu) {
                    contactMenu.onclick = function() {
                        if (mainMenu) mainMenu.style.display = 'none';
                        const modal = document.getElementById('contactModal');
                        if (modal) modal.style.display = 'flex';
                    };
                }
                // Modal close logic
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.onclick = function() {
                        btn.closest('.modal').style.display = 'none';
                        if (btn.closest('.modal').id === 'galleryModal') {
                            document.getElementById('galleryVideoPlayer').pause();
                            document.getElementById('galleryVideoPlayer').style.display = 'none';
                        }
                    };
                });
                // Gallery video click
                document.querySelectorAll('.gallery-thumb').forEach(thumb => {
                    thumb.onclick = function() {
                        const videoSrc = thumb.getAttribute('data-video');
                        const player = document.getElementById('galleryVideoPlayer');
                        player.pause();
                        player.currentTime = 0;
                        player.src = videoSrc;
                        player.style.display = 'block';
                        player.muted = false;
                        player.volume = 1;
                        player.play();
                    };
                });
                // Play in Experience buttons
                document.querySelectorAll('.play-experience-btn').forEach(btn => {
                    btn.onclick = function(e) {
                        const idx = parseInt(btn.getAttribute('data-index'));
                        // Reset gallery preview
                        const galleryPlayer = document.getElementById('galleryVideoPlayer');
                        galleryPlayer.pause();
                        galleryPlayer.currentTime = 0;
                        galleryPlayer.src = '';
                        galleryPlayer.style.display = 'none';
                        // Play video on sphere
                        if (window.panoramaPlayer && typeof window.panoramaPlayer.playVideoByIndex === 'function') {
                            window.panoramaPlayer.playVideoByIndex(idx);
                        }
                        document.getElementById('galleryModal').style.display = 'none';
                    };
                });
                // Gallery audio controls
                const galleryPlayer = document.getElementById('galleryVideoPlayer');
                const galleryMuteBtn = document.getElementById('galleryMuteBtn');
                const galleryVolume = document.getElementById('galleryVolume');
                if (galleryMuteBtn && galleryPlayer) {
                    galleryMuteBtn.onclick = function() {
                        galleryPlayer.muted = !galleryPlayer.muted;
                        galleryMuteBtn.textContent = galleryPlayer.muted ? 'Unmute' : 'Mute';
                    };
                }
                if (galleryVolume && galleryPlayer) {
                    galleryVolume.oninput = function() {
                        galleryPlayer.volume = parseFloat(galleryVolume.value);
                    };
                }
            });
            // Contact form submission (demo, no backend)
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('contactForm');
                if (form) {
                    form.onsubmit = function(e) {
                        e.preventDefault();
                        form.style.display = 'none';
                        document.getElementById('contactSuccess').style.display = 'block';
                    };
                }
            });
            // Main controls audio mute/unmute and volume
            // --- Main Experience Audio Controls ---
            const audioMuteBtn = document.getElementById('audioMuteBtn');
            const mainVolume = document.getElementById('mainVolume');
            const audioMuteIcon = document.getElementById('audioMuteIcon');

            function getCurrentVideo() {
                return window.panoramaPlayer && window.panoramaPlayer.video instanceof HTMLVideoElement ? window.panoramaPlayer.video : null;
            }

            function updateAudioControls() {
                const video = getCurrentVideo();
                if (video) {
                    mainVolume.disabled = false;
                    audioMuteBtn.disabled = false;
                    mainVolume.value = video.volume;
                    audioMuteIcon.textContent = video.muted ? 'volume_off' : 'volume_up';
                } else {
                    mainVolume.disabled = true;
                    audioMuteBtn.disabled = true;
                }
            }

            function attachAudioEvents(video) {
                if (!video) return;
                video.onvolumechange = updateAudioControls;
                video.onplay = updateAudioControls;
                video.onloadeddata = updateAudioControls;
            }

            function setAudioEventListeners() {
                // Remove previous listeners by re-assigning
                if (audioMuteBtn) {
                    audioMuteBtn.onclick = function() {
                        if (window.panoramaPlayer && !audioMuteBtn.disabled) {
                            // Let PanoramaPlayer handle ALL audio toggling
                            window.panoramaPlayer.toggleMute();
                            
                            // Update UI to match
                            const video = getCurrentVideo();
                            if (video) {
                                audioMuteIcon.textContent = video.muted ? 'volume_off' : 'volume_up';
                            }
                            updateAudioControls();
                            console.log('[AUDIO] PanoramaPlayer.toggleMute() called - muted:', video?.muted);
                        } else {
                            console.warn('[AUDIO] mute button: PanoramaPlayer not available or control disabled');
                        }
                    };
                }
                if (mainVolume) {
                    mainVolume.oninput = function() {
                        const newVolume = parseFloat(mainVolume.value);
                        
                        if (window.panoramaPlayer && !mainVolume.disabled) {
                            // Route through PanoramaPlayer to control ALL audio sources
                            window.panoramaPlayer.setVolume(newVolume);
                            console.log('[AUDIO] Master volume set via PanoramaPlayer:', Math.round(newVolume * 100) + '%');
                        } else {
                            // Fallback to video only if PanoramaPlayer not available
                            const video = getCurrentVideo();
                            if (video) {
                                video.volume = newVolume;
                                console.log('[AUDIO] Video volume set (fallback):', newVolume);
                            }
                        }
                        updateAudioControls();
                    };
                }
            }

            // Patch panoramaPlayer.loadVideo to always re-sync controls
            if (window.panoramaPlayer) {
                const origLoadVideo = window.panoramaPlayer.loadVideo;
                window.panoramaPlayer.loadVideo = function(url) {
                    const result = origLoadVideo.call(this, url);
                    setTimeout(function() {
                        const video = getCurrentVideo();
                        if (video) {
                            // Attach listeners and update controls immediately after loadeddata
                            video.addEventListener('loadeddata', function loadedHandler() {
                                attachAudioEvents(video);
                                setAudioEventListeners();
                                updateAudioControls();
                                video.removeEventListener('loadeddata', loadedHandler);
                                console.log('[AUDIO] controls enabled and synced after loadeddata');
                            });
                        } else {
                            mainVolume.disabled = true;
                            audioMuteBtn.disabled = true;
                        }
                        // Also run once in case loadeddata already fired
                        setAudioEventListeners();
                        updateAudioControls();
                        console.log('[AUDIO] controls updated after video load, video:', video);
                    }, 500);
                    return result;
                };
            }

            // Initial sync
            // Listen for custom event when main video is ready
            window.addEventListener('mainVideoReady', function() {
                const video = getCurrentVideo();
                console.log('[DEBUG] mainVideoReady event fired, getCurrentVideo:', video);
                attachAudioEvents(video);
                setAudioEventListeners();
                updateAudioControls();
                console.log('[AUDIO] controls enabled and synced after mainVideoReady event, video:', video);
                if (video) {
                    console.log('[DEBUG] video.muted:', video.muted, 'video.volume:', video.volume);
                } else {
                    console.warn('[DEBUG] No video element found in getCurrentVideo after mainVideoReady');
                }
            });
            </script>
    </div>

    <!-- Webpack will inject the correct bundled script automatically. -->
     <script type="module" src="js/app.js?v=1763319206"></script>
    
    <!-- PWA Install Button -->
    <button id="pwa-install-btn" style="display: none;">üì± Install App</button>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Only enable Service Worker for VR headsets (Meta Quest), not mobile devices
        const isVRHeadset = /OculusBrowser|Quest/i.test(navigator.userAgent);
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        if ('serviceWorker' in navigator && isVRHeadset) {
            // Only register on VR headsets
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ [PWA] Service Worker registered on VR headset:', registration);
                    })
                    .catch(error => {
                        console.error('‚ùå [PWA] Service Worker registration failed:', error);
                    });
            });
        } else if ('serviceWorker' in navigator && isMobile) {
            // Unregister and clear caches on mobile devices, then force reload
            const needsReload = sessionStorage.getItem('sw_cleaned') !== 'true';
            
            navigator.serviceWorker.getRegistrations().then(registrations => {
                const unregisterPromises = registrations.map(registration => {
                    return registration.unregister().then(success => {
                        if (success) {
                            console.log('üóëÔ∏è [PWA] Service Worker unregistered on mobile');
                        }
                        return success;
                    });
                });
                
                return Promise.all(unregisterPromises);
            }).then(() => {
                // Clear all caches
                if ('caches' in window) {
                    return caches.keys().then(cacheNames => {
                        return Promise.all(
                            cacheNames.map(cacheName => {
                                console.log('üóëÔ∏è [PWA] Clearing cache:', cacheName);
                                return caches.delete(cacheName);
                            })
                        );
                    });
                }
            }).then(() => {
                console.log('‚úÖ [PWA] All caches cleared on mobile');
                
                // Force reload once to ensure clean state
                if (needsReload) {
                    sessionStorage.setItem('sw_cleaned', 'true');
                    console.log('üîÑ [PWA] Reloading page to clear Service Worker...');
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            });
            
            console.log('‚ö†Ô∏è [PWA] Service Worker disabled on mobile devices');
        }
        
        // PWA Install Prompt - Enhanced for Meta Quest
        let deferredPrompt;
        const installButton = document.getElementById('pwa-install-btn');

        // Detect Quest browser
        const isQuestBrowser = /OculusBrowser|Quest/i.test(navigator.userAgent);
        const hasWebXR = 'xr' in navigator;

        // Show install button on Quest even without beforeinstallprompt
        if ((isQuestBrowser || hasWebXR) && installButton) {
            installButton.style.display = 'block';
            installButton.title = 'Add to Quest Library: Press ... menu > Add to Home Screen';
            console.log('üì± PWA install button shown for Quest/WebXR browser');
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installButton) {
                installButton.style.display = 'block';
                console.log('üì± PWA install prompt available');
            }
        });

        if (installButton) {
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    // Standard PWA install flow
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installButton.style.display = 'none';
                } else if (isQuestBrowser) {
                    // Show manual instructions for Quest
                    alert('To install EyeTrip VR on Quest:\n\n1. Press the "..." menu button\n2. Select "Add to Home Screen"\n3. Access from your Quest Library\n\nThis allows offline access and a native app experience!');
                } else {
                    // Generic instructions
                    alert('To install:\n\nUse your browser\'s menu to "Add to Home Screen" or "Install App"');
                }
            });
        }

        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA installed');
            if (installButton) {
                installButton.style.display = 'none';
            }
        });
    </script>
    
    <!-- Intro Overlay JavaScript -->
    <script>
        (function initIntroOverlay() {
            'use strict';
            
            // Cookie utilities
            function setCookie(name, value, days) {
                const expires = new Date(Date.now() + days * 864e5).toUTCString();
                document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/; SameSite=Lax';
            }
            
            function getCookie(name) {
                return document.cookie.split('; ').reduce((r, v) => {
                    const parts = v.split('=');
                    return parts[0] === name ? decodeURIComponent(parts[1]) : r;
                }, '');
            }
            
            const introOverlay = document.getElementById('introOverlay');
            const startBtn = document.getElementById('startExperienceBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            if (!introOverlay || !startBtn) {
                console.warn('[INTRO] Overlay elements not found');
                return;
            }
            
            let overlayShown = false;
            let experienceStarted = false;
            
            // Check if user has seen intro before
            const hasSeenIntro = getCookie('eyetrip_intro_seen') === 'true';
            
            // Pause video until user clicks Start Experience
            function pauseVideoUntilStart() {
                // Hook into app initialization to pause video
                const originalMainVideoReady = window.mainVideoReady;
                window.addEventListener('mainVideoReady', () => {
                    if (!experienceStarted && !hasSeenIntro) {
                        setTimeout(() => {
                            const video = window.panoramaPlayer?.video;
                            if (video && !video.paused) {
                                video.pause();
                                console.log('‚è∏Ô∏è [INTRO] Video paused - waiting for user to start');
                            }
                        }, 100);
                    }
                });
            }
            
            // Show intro overlay function
            function showIntroOverlay() {
                if (overlayShown || hasSeenIntro) return;
                
                const isInVR = window.panoramaPlayer?.renderer?.xr?.isPresenting;
                if (isInVR) return;
                
                // Show overlay with fade-in
                introOverlay.style.display = 'flex';
                // Force reflow for transition
                void introOverlay.offsetWidth;
                introOverlay.classList.add('visible');
                overlayShown = true;
                
                console.log('‚ú® [INTRO] Overlay shown for first-time visitor');
            }
            
            // Hide intro overlay function
            function hideIntroOverlay() {
                if (!introOverlay) return;
                
                // Fade out
                introOverlay.classList.remove('visible');
                
                setTimeout(() => {
                    introOverlay.style.display = 'none';
                    console.log('üëã [INTRO] Overlay hidden');
                }, 300); // Match CSS transition duration
            }
            
            // Handle start button click - prevent double-triggers on mobile
            let clickHandled = false;
            function handleStartClick(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (clickHandled) return;
                clickHandled = true;
                experienceStarted = true;
                
                console.log('‚ñ∂Ô∏è [INTRO] Start button clicked - starting experience');
                
                // Set cookie to remember user has seen intro
                setCookie('eyetrip_intro_seen', 'true', 365); // Remember for 1 year
                
                // Hide overlay
                hideIntroOverlay();
                
                // Start the video playback
                setTimeout(() => {
                    const video = window.panoramaPlayer?.video;
                    if (video) {
                        video.play().then(() => {
                            console.log('‚ñ∂Ô∏è [INTRO] Video playback started');
                        }).catch(err => {
                            console.warn('[INTRO] Video play failed:', err);
                        });
                    }
                }, 100);
                
                // Track event
                if (window.trackVREvent) {
                    window.trackVREvent('intro_completed', 'first_visit', 1);
                }
            }
            
            // Touch-optimized event listeners
            startBtn.addEventListener('click', handleStartClick);
            startBtn.addEventListener('touchend', (e) => {
                e.preventDefault(); // Prevent ghost click on mobile
                handleStartClick(e);
            });
            
            // Keyboard accessibility (Enter or Space)
            startBtn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    handleStartClick(e);
                }
            });
            
            // Show overlay immediately on page load for first-time visitors
            if (!hasSeenIntro) {
                // Show overlay as soon as DOM is ready
                document.addEventListener('DOMContentLoaded', () => {
                    showIntroOverlay();
                });
                
                // If DOM already loaded, show now
                if (document.readyState === 'interactive' || document.readyState === 'complete') {
                    showIntroOverlay();
                }
                
                // Pause video when it's ready
                pauseVideoUntilStart();
            } else {
                console.log('üë§ [INTRO] Returning visitor - overlay skipped');
                experienceStarted = true; // Auto-start for returning visitors
            }
            
            // Hide overlay if user enters VR mode
            document.addEventListener('DOMContentLoaded', () => {
                if (window.panoramaPlayer?.renderer?.xr) {
                    window.panoramaPlayer.renderer.xr.addEventListener('sessionstart', () => {
                        if (overlayShown) {
                            hideIntroOverlay();
                            experienceStarted = true;
                            console.log('ü•Ω [INTRO] Hidden due to VR session start');
                        }
                    });
                }
            });
            
            // Expose for debugging
            window.debugIntroOverlay = {
                show: showIntroOverlay,
                hide: hideIntroOverlay,
                reset: () => {
                    document.cookie = 'eyetrip_intro_seen=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    console.log('üîÑ [INTRO] Cookie reset - reload page to see intro');
                    location.reload();
                }
            };
        })();
    </script>
</body>
</html>
