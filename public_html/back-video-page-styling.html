<html lang="en" style="--high-contrast: true;"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affirmation Journey: Matrix Caracas Sphere | EyeTrip VR</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="EyeTrip VR">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EyeTrip VR">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" href="images/eyetripvr-icon.png">
    <link rel="apple-touch-icon" href="images/eyetripvr-icon.png">
    <link rel="stylesheet" href="css/eyetrip-style.css">
    
    <!-- Google Analytics 4 -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-7Y1YJBXJ2X"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7Y1YJBXJ2X', {
            'page_title': 'Affirmation Journey: Matrix Caracas Sphere | EyeTrip VR',
            'page_path': window.location.pathname
        });
        
        // VR Event Tracking Helper
        window.trackVREvent = function(action, label, value) {
            console.log('ðŸ“Š Tracking:', action, label, value);
            gtag('event', action, {
                'event_category': 'VR_Engagement',
                'event_label': label,
                'value': value
            });
        };
    </script>
    
    <!-- Import map to resolve bare module specifiers -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.153.0/build/three.module.js",
            "three/": "https://unpkg.com/three@0.153.0/"
        }
    }
    </script>
    
    <!-- WebXR Polyfill for broader support - load first -->
    <script src="https://unpkg.com/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>
    <script>
        // Initialize WebXR polyfill immediately
        if (window.WebXRPolyfill) {
            console.log('WebXR Polyfill loaded and initialized');
        }
        
        // Browser compatibility check
        (function checkBrowserCompatibility() {
            const warnings = [];
            
            // Check WebGL support
            if (!window.WebGLRenderingContext) {
                warnings.push('WebGL is not supported');
            } else {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) {
                    warnings.push('WebGL context could not be created');
                }
            }
            
            // Check for basic ES6 support
            try {
                eval('const test = () => {};');
            } catch (e) {
                warnings.push('Modern JavaScript (ES6) is not supported');
            }
            
            if (warnings.length > 0) {
                console.error('Browser compatibility issues:', warnings);
                setTimeout(() => {
                    alert(
                        'Your browser may not fully support this VR experience.\\n\\n' +
                        'Issues detected:\\nâ€¢ ' + warnings.join('\\nâ€¢ ') + '\\n\\n' +
                        'Please use Chrome, Firefox, Edge, or Safari on a recent device for best results.'
                    );
                }, 1000);
            }
        })();
        
        // Set single video configuration
        sessionStorage.setItem('selectedVideo', 'assets/videos/processed/matrixCaracasSphere_1/matrixCaracasSphere_1_1080p.mp4');
        sessionStorage.setItem('selectedTitle', 'Affirmation Journey: Matrix Caracas Sphere');
        sessionStorage.setItem('isAffirmationMode', 'true'); // Flag for affirmation mode
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/material-ui.css">
    <link rel="stylesheet" href="css/app.css">
    <style>
        /* Gallery thumbnail hover effects */
        .gallery-thumb {
            transition: transform 0.25s ease, box-shadow 0.25s ease, filter 0.25s ease !important;
        }
        .gallery-thumb:hover {
            transform: scale(1.08) !important;
            box-shadow: 0 8px 24px rgba(25, 118, 210, 0.4), 0 0 20px rgba(205, 0, 255, 0.3) !important;
            filter: brightness(1.1) !important;
        }
        .gallery-item {
            transition: transform 0.25s ease !important;
        }
        .gallery-item:hover {
            transform: translateY(-4px) !important;
        }
    </style>
<style id="high-contrast-css">
            body.high-contrast {
                background: #000;
                color: #FFF;
            }
            
            body.high-contrast button {
                background: #000 !important;
                color: #FFF !important;
                border: 2px solid #FFF !important;
            }
            
            body.high-contrast button:hover {
                background: #FFF !important;
                color: #000 !important;
            }
            
            body.high-contrast a {
                color: #FFFF00 !important;
                text-decoration: underline !important;
            }
        </style><style id="pwa-animations">
                @keyframes pulseInstall {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                }
            </style></head>
<body data-app-initialized="true" class="high-contrast">
    <!-- Hamburger menu for video switching is now a child of the header -->
        <script>
        // Hamburger menu toggle
        document.addEventListener('DOMContentLoaded', function() {
            const menuButton = document.getElementById('menuButton');
            const videoList = document.getElementById('videoList');
            if (menuButton && videoList) {
                menuButton.addEventListener('click', function() {
                    videoList.style.display = videoList.style.display === 'block' ? 'none' : 'block';
                });
            }
            // Video switch buttons
            const videoButtons = document.querySelectorAll('.video-switch');
            videoButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const idx = parseInt(btn.getAttribute('data-index'));
                    if (window.panoramaPlayer && typeof window.panoramaPlayer.playVideoByIndex === 'function') {
                        window.panoramaPlayer.playVideoByIndex(idx);
                    }
                    videoList.style.display = 'none';
                });
            });
        });
        </script>
    <div id="container">
    <!-- Start Experience Overlay -->
        <!-- Removed Start Experience Overlay and logic -->
        <script>
        // Play button logic (ensure video/audio starts on play)
                document.addEventListener('DOMContentLoaded', function() {
                    const playBtn = document.getElementById('playBtn');
                            if (playBtn) {
                                playBtn.addEventListener('click', () => {
                                    if (window.sceneManager && typeof window.sceneManager.loadScene === 'function') {
                                        window.sceneManager.loadScene(0).then(() => {
                                            const video = window.panoramaPlayer && window.panoramaPlayer.video;
                                            if (video) {
                                                video.play().then(() => {
                                                    document.getElementById('audioMuteBtn').disabled = false;
                                                    document.getElementById('mainVolume').disabled = false;
                                                    console.log('[AUDIO] controls enabled after play');
                                                }).catch((err) => {
                                                    console.warn('[AUDIO] video play failed:', err);
                                                });
                                            }
                                        });
                                    }
                                });
                            }

                });
        // Audio controls (mute/unmute, volume) remain unchanged and work in desktop mode
        </script>
    <div id="videoProgressBar" style="position: fixed; top: 0px; left: 0px; width: 100vw; height: 6px; background: rgb(238, 238, 238); z-index: 100000; display: none;">
            <div id="videoProgress" style="height:100%;width:0;background:#1976d2;transition:width 0.2s;"></div>
        </div>
        <div id="canvas-container"><canvas data-engine="three.js r153" width="1510" height="1600" style="display: block; width: 755px; height: 800px; opacity: 1; transition: opacity 0.5s;"></canvas></div>
        
        <div class="md-ui-layer">
            <div class="md-top-bar hidden" id="topBar">
                <button class="md-button" onclick="window.location.href='gallery.html'" style="margin-right: 8px;" title="Back to Gallery">
                    <span class="material-icons">arrow_back</span>
                </button>
                <div class="md-title" style="display: inline-flex; align-items: center; vertical-align: middle;">
                    <img src="images/eyetripimagesvr-wide.svg?v=2" alt="EyeTripVR" style="height: 40px; width: auto; filter: brightness(0) invert(1) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.6)); margin-right: 16px;">
                    <span>âœ¨ Affirmation Journey</span>
                </div>
                    <div id="mainMenu" style="display: none; background: #222; color: #fff; border-radius: 4px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); position: absolute; left: 16px; min-width: 180px;">
                        <ul style="list-style: none; margin: 0; padding: 0;">
                            <li id="galleryMenu" class="main-menu-item">Change Scene</li>
                            <li id="aboutMenu" class="main-menu-item">About</li>
                            <li id="contactMenu" class="main-menu-item" style="border-bottom:none;">Contact</li>
                        </ul>
                        <style>
                        #mainMenu {
                            background: #23272f;
                            color: #fff;
                            border-radius: 12px;
                            margin-top: 12px;
                            box-shadow: 0 6px 24px rgba(0,0,0,0.25);
                            padding: 8px 0;
                            min-width: 200px;
                            font-family: 'Roboto', sans-serif;
                        }
                        #mainMenu ul {
                            padding: 0;
                            margin: 0;
                        }
                        .main-menu-item {
                            padding: 16px 32px;
                            border-bottom: 1px solid #353a45;
                            cursor: pointer;
                            font-size: 1.08em;
                            transition: background 0.18s, color 0.18s;
                            border-radius: 8px;
                            margin: 0 8px;
                        }
                        .main-menu-item:last-child {
                            border-bottom: none;
                        }
                        .main-menu-item:hover {
                            background: #1976d2;
                            color: #fff;
                            box-shadow: 0 2px 8px rgba(25,118,210,0.12);
                        }
                        </style>
                    </div>
                </div>
                <div class="md-title" style="display: inline-block; vertical-align: middle;">EyeTrip Images - 360Â° Experience</div>
                <button class="md-button" id="settingsBtn">
                    <span class="material-icons">settings</span>
                </button>
                <style>
                    #settingsBtn { display: none !important; }
                </style>
            </div>

            <div class="md-scene-selector hidden" id="sceneSelector">
            
                <div class="md-scene-item active" data-scene="0">
                    <div class="md-scene-info" style="color: white; padding: 10px;">
                        <div class="md-scene-title">Affirmation Journey: Matrix Caracas Sphere</div>
                        <div class="md-scene-duration">0:00</div>
                    </div>
                </div>
            
        </div>

            <div class="md-controls hidden" id="controls">
                <button class="md-button" id="prevBtn" style="visibility: hidden;">
                    <span class="material-icons">skip_previous</span>
                </button>
                <button class="md-button md-primary pulse-animation" id="playBtn" style="display: flex;">
                    <span class="material-icons">play_arrow</span>
                </button>
                <button class="md-button" id="nextBtn" style="visibility: hidden;">
                    <span class="material-icons">skip_next</span>
                </button>
                <!-- Audio controls start -->
                <button class="md-button" id="audioMuteBtn" title="Mute/Unmute" style="margin-left:16px;">
                    <span class="material-icons" id="audioMuteIcon">volume_up</span>
                </button>
                <input id="mainVolume" type="range" min="0" max="1" step="0.01" value="1" style="width:100px; vertical-align:middle; margin:0 8px;">
                <!-- Time display -->
                <div id="videoTime" style="color: white; font-size: 14px; margin: 0 16px; font-family: 'Roboto Mono', monospace; min-width: 100px; text-align: center;">0:00 / 4:16</div>
                <!-- Audio controls end -->
                <button class="md-button" id="fullscreenBtn">
                    <span class="material-icons">fullscreen</span>
                </button>
                <!-- Exit to Gallery Button -->
                <button class="control-btn md-button" id="exitBtn" title="Exit to Gallery (ESC)" style="margin-left: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <!-- Debug overlay for sphere/texture status -->
                <div id="debugOverlay" style="position:fixed;top:10px;right:10px;z-index:9999;background:#222;color:#fff;padding:8px;border-radius:4px;display:none;font-size:14px;"></div>
                <!-- VRButton from Three.js will be injected by PanoramaPlayer.js -->
            <button id="VRButton" style="position: static; margin-left: 8px; width: 100px; cursor: pointer; left: calc(50% - 50px); opacity: 0.5;" title="Enter immersive VR mode - requires Meta Quest or compatible WebXR headset">ENTER VR</button></div>

            <div class="md-vr-indicator" id="vrIndicator">
                VR Mode Active
            </div>

            <div class="md-loading" id="loadingOverlay" style="display: none;">
                        <div class="md-spinner"></div>
                        <div>Loading 360Â° Experience...</div>
                        <div id="loadingProgress" style="margin-top: 10px; font-size: 18px; font-weight: bold;">5%</div>
                    </div>

            <div class="" id="webxrBadge" style="display: block !important; position: fixed !important; bottom: 20px !important; left: 20px !important; top: auto !important; background: rgb(76, 175, 80) !important; color: white !important; padding: 4px 8px !important; border-radius: 4px !important; font-family: Arial, sans-serif !important; font-size: 11px !important; font-weight: normal !important; z-index: 1000 !important; max-width: 120px !important; width: auto !important; height: auto !important; text-align: center !important; pointer-events: none !important; box-shadow: rgba(0, 0, 0, 0.2) 0px 2px 4px !important; margin: 0px !important; border: none !important; outline: none !important;">WebXR Ready</div>

            <button class="md-fab" id="fabBtn">
                <span class="material-icons">360</span>
            </button>
            <style>
                #fabBtn { display: none !important; }
            </style>
        </div>
            <!-- Gallery Modal -->
            <div class="modal" id="galleryModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:10001; align-items:center; justify-content:center;">
                <div style="background:#222; color:#fff; border-radius:16px; padding:32px; max-width:1000px; width:96vw; position:relative; box-shadow:0 8px 32px rgba(0,0,0,0.35); overflow-y:auto; max-height:90vh;">
                    <button class="modal-close" style="position:absolute; top:16px; right:16px; background:none; border:none; color:#fff; font-size:28px; cursor:pointer;">Ã—</button>
                    <h2 style="margin-top:0; margin-bottom:24px; font-size:2em; font-weight:500; letter-spacing:0.02em;">Select Experience</h2>
                    <div class="gallery-grid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:18px; margin-bottom:24px;">
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video1.png" data-video="assets/videos/stumpy_rect_2_1_4ktest_isVR.mp4" data-index="0" alt="Video 1" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="0" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video2.png" data-video="assets/videos/stumpy_rect_2_1_4ktest.mp4" data-index="1" alt="Video 2" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="1" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video3.png" data-video="assets/videos/stumpy_rect_16_9_4ktest_isVR.mp4" data-index="2" alt="Video 3" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="2" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                        <div class="gallery-item" style="background:#23272f; border-radius:12px; box-shadow:0 2px 12px rgba(25,118,210,0.10); padding:10px; display:flex; flex-direction:column; align-items:center; max-width:170px;">
                            <img class="gallery-thumb" src="assets/thumbnails/eyetrip-test-video4.png" data-video="assets/videos/stumpy_rect_16_9_4ktest_isVR.mp4" data-index="3" alt="Video 4" style="width:100%; max-width:150px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <button class="play-experience-btn" data-index="3" style="margin-top:8px; width:100%; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:8px; font-size:0.95em; cursor:pointer; font-weight:500;">Play in Experience</button>
                        </div>
                    </div>
                    <video id="galleryVideoPlayer" controls="" style="width:100%; border-radius:6px; display:none; background:#000;"></video>
                </div>
            </div>

            <!-- About Modal -->
            <div class="modal" id="aboutModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:10001; align-items:center; justify-content:center;">
                <div style="background:#222; color:#fff; border-radius:8px; padding:32px; max-width:500px; width:90vw; position:relative;">
                    <button class="modal-close" style="position:absolute; top:16px; right:16px; background:none; border:none; color:#fff; font-size:28px; cursor:pointer;">Ã—</button>
                    <h2 style="margin-top:0;">About</h2>
                    <p style="font-size:1.1em; line-height:1.6;">Welcome to EyeTrip Images 360Â° Experience. Immerse yourself in a curated selection of panoramic videos and explore new perspectives. This is a placeholder for more information about the project, the creators, and the vision behind EyeTrip Images. Stay tuned for updates!</p>
                </div>
            </div>

            <!-- Contact Modal -->
            <div class="modal" id="contactModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:10001; align-items:center; justify-content:center;">
                <div style="background:#222; color:#fff; border-radius:8px; padding:32px; max-width:400px; width:90vw; position:relative;">
                    <button class="modal-close" style="position:absolute; top:16px; right:16px; background:none; border:none; color:#fff; font-size:28px; cursor:pointer;">Ã—</button>
                    <h2 style="margin-top:0;">Contact</h2>
                    <form id="contactForm" style="display:flex; flex-direction:column; gap:16px;">
                        <input type="email" name="email" placeholder="Your email" required="" style="padding:10px; border-radius:4px; border:none; font-size:1em;">
                        <textarea name="message" placeholder="Your message" required="" style="padding:10px; border-radius:4px; border:none; font-size:1em; min-height:80px;"></textarea>
                        <button type="submit" style="background:#1976d2; color:#fff; border:none; border-radius:4px; padding:10px; font-size:1em; cursor:pointer;">Send</button>
                    </form>
                    <div id="contactSuccess" style="display:none; color:#4caf50; margin-top:12px;">Thank you! Your message has been sent.</div>
                </div>
            </div>
            <script>
            // Hamburger menu toggle and modal logic
            document.addEventListener('DOMContentLoaded', function() {
                const menuButton = document.getElementById('menuButton');
                const mainMenu = document.getElementById('mainMenu');
                
                if (menuButton && mainMenu) {
                    menuButton.addEventListener('click', function() {
                        mainMenu.style.display = mainMenu.style.display === 'block' ? 'none' : 'block';
                    });
                }
                
                // Modal triggers
                const galleryMenu = document.getElementById('galleryMenu');
                const aboutMenu = document.getElementById('aboutMenu');
                const contactMenu = document.getElementById('contactMenu');
                
                if (galleryMenu) {
                    galleryMenu.onclick = function() {
                        if (mainMenu) mainMenu.style.display = 'none';
                        const modal = document.getElementById('galleryModal');
                        if (modal) modal.style.display = 'flex';
                    };
                }
                
                if (aboutMenu) {
                    aboutMenu.onclick = function() {
                        if (mainMenu) mainMenu.style.display = 'none';
                        const modal = document.getElementById('aboutModal');
                        if (modal) modal.style.display = 'flex';
                    };
                }
                
                if (contactMenu) {
                    contactMenu.onclick = function() {
                        if (mainMenu) mainMenu.style.display = 'none';
                        const modal = document.getElementById('contactModal');
                        if (modal) modal.style.display = 'flex';
                    };
                }
                // Modal close logic
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.onclick = function() {
                        btn.closest('.modal').style.display = 'none';
                        if (btn.closest('.modal').id === 'galleryModal') {
                            document.getElementById('galleryVideoPlayer').pause();
                            document.getElementById('galleryVideoPlayer').style.display = 'none';
                        }
                    };
                });
                // Gallery video click
                document.querySelectorAll('.gallery-thumb').forEach(thumb => {
                    thumb.onclick = function() {
                        const videoSrc = thumb.getAttribute('data-video');
                        const player = document.getElementById('galleryVideoPlayer');
                        player.pause();
                        player.currentTime = 0;
                        player.src = videoSrc;
                        player.style.display = 'block';
                        player.muted = false;
                        player.volume = 1;
                        player.play();
                    };
                });
                // Play in Experience buttons
                document.querySelectorAll('.play-experience-btn').forEach(btn => {
                    btn.onclick = function(e) {
                        const idx = parseInt(btn.getAttribute('data-index'));
                        // Reset gallery preview
                        const galleryPlayer = document.getElementById('galleryVideoPlayer');
                        galleryPlayer.pause();
                        galleryPlayer.currentTime = 0;
                        galleryPlayer.src = '';
                        galleryPlayer.style.display = 'none';
                        // Play video on sphere
                        if (window.panoramaPlayer && typeof window.panoramaPlayer.playVideoByIndex === 'function') {
                            window.panoramaPlayer.playVideoByIndex(idx);
                        }
                        document.getElementById('galleryModal').style.display = 'none';
                    };
                });
                // Gallery audio controls
                const galleryPlayer = document.getElementById('galleryVideoPlayer');
                const galleryMuteBtn = document.getElementById('galleryMuteBtn');
                const galleryVolume = document.getElementById('galleryVolume');
                if (galleryMuteBtn && galleryPlayer) {
                    galleryMuteBtn.onclick = function() {
                        galleryPlayer.muted = !galleryPlayer.muted;
                        galleryMuteBtn.textContent = galleryPlayer.muted ? 'Unmute' : 'Mute';
                    };
                }
                if (galleryVolume && galleryPlayer) {
                    galleryVolume.oninput = function() {
                        galleryPlayer.volume = parseFloat(galleryVolume.value);
                    };
                }
            });
            // Contact form submission (demo, no backend)
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('contactForm');
                if (form) {
                    form.onsubmit = function(e) {
                        e.preventDefault();
                        form.style.display = 'none';
                        document.getElementById('contactSuccess').style.display = 'block';
                    };
                }
            });
            // Main controls audio mute/unmute and volume
            // --- Main Experience Audio Controls ---
            const audioMuteBtn = document.getElementById('audioMuteBtn');
            const mainVolume = document.getElementById('mainVolume');
            const audioMuteIcon = document.getElementById('audioMuteIcon');

            function getCurrentVideo() {
                return window.panoramaPlayer && window.panoramaPlayer.video instanceof HTMLVideoElement ? window.panoramaPlayer.video : null;
            }

            function updateAudioControls() {
                const video = getCurrentVideo();
                if (video) {
                    mainVolume.disabled = false;
                    audioMuteBtn.disabled = false;
                    mainVolume.value = video.volume;
                    audioMuteIcon.textContent = video.muted ? 'volume_off' : 'volume_up';
                } else {
                    mainVolume.disabled = true;
                    audioMuteBtn.disabled = true;
                }
            }

            function attachAudioEvents(video) {
                if (!video) return;
                video.onvolumechange = updateAudioControls;
                video.onplay = updateAudioControls;
                video.onloadeddata = updateAudioControls;
            }

            function setAudioEventListeners() {
                // Remove previous listeners by re-assigning
                if (audioMuteBtn) {
                    audioMuteBtn.onclick = function() {
                        const video = getCurrentVideo();
                        if (video && !audioMuteBtn.disabled) {
                            video.muted = !video.muted;
                            audioMuteIcon.textContent = video.muted ? 'volume_off' : 'volume_up';
                            updateAudioControls();
                            console.log('[AUDIO] mute toggled:', video.muted);
                        } else {
                            console.warn('[AUDIO] mute button: no video element or control disabled');
                        }
                    };
                }
                if (mainVolume) {
                    mainVolume.oninput = function() {
                        const video = getCurrentVideo();
                        if (video && !mainVolume.disabled) {
                            video.volume = parseFloat(mainVolume.value);
                            updateAudioControls();
                            console.log('[AUDIO] volume set:', video.volume);
                        } else {
                            console.warn('[AUDIO] volume slider: no video element or control disabled');
                        }
                    };
                }
            }

            // Patch panoramaPlayer.loadVideo to always re-sync controls
            if (window.panoramaPlayer) {
                const origLoadVideo = window.panoramaPlayer.loadVideo;
                window.panoramaPlayer.loadVideo = function(url) {
                    const result = origLoadVideo.call(this, url);
                    setTimeout(function() {
                        const video = getCurrentVideo();
                        if (video) {
                            // Attach listeners and update controls immediately after loadeddata
                            video.addEventListener('loadeddata', function loadedHandler() {
                                attachAudioEvents(video);
                                setAudioEventListeners();
                                updateAudioControls();
                                video.removeEventListener('loadeddata', loadedHandler);
                                console.log('[AUDIO] controls enabled and synced after loadeddata');
                            });
                        } else {
                            mainVolume.disabled = true;
                            audioMuteBtn.disabled = true;
                        }
                        // Also run once in case loadeddata already fired
                        setAudioEventListeners();
                        updateAudioControls();
                        console.log('[AUDIO] controls updated after video load, video:', video);
                    }, 500);
                    return result;
                };
            }

            // Initial sync
            // Listen for custom event when main video is ready
            window.addEventListener('mainVideoReady', function() {
                const video = getCurrentVideo();
                console.log('[DEBUG] mainVideoReady event fired, getCurrentVideo:', video);
                attachAudioEvents(video);
                setAudioEventListeners();
                updateAudioControls();
                console.log('[AUDIO] controls enabled and synced after mainVideoReady event, video:', video);
                if (video) {
                    console.log('[DEBUG] video.muted:', video.muted, 'video.volume:', video.volume);
                } else {
                    console.warn('[DEBUG] No video element found in getCurrentVideo after mainVideoReady');
                }
            });
            </script>
    

    <!-- Webpack will inject the correct bundled script automatically. -->
     <script type="module" src="js/app.js"></script>
    
    <!-- Affirmation System Integration -->
    <script type="module">
        import { AffirmationExporter } from './js/modules/AffirmationExporter.js';
        
        // Global affirmation state
        window.affirmationState = {
            exporter: null,
            generatedAffirmations: [],
            collectedAffirmations: [],
            userResponses: null,
            isInitialized: false
        };
        
        console.log('âœ¨ Affirmation experience loading...');
        
        // Wait for app to be ready
        function waitForApp() {
            if (window.app && window.app.hotspotManager) {
                console.log('âœ… App ready, loading affirmation data');
                loadAffirmationData();
            } else {
                console.log('â³ Waiting for app...');
                setTimeout(waitForApp, 500);
            }
        }
        
        // Load affirmation data from sessionStorage
        function loadAffirmationData() {
            if (window.affirmationState.isInitialized) return;
            
            // Get data from sessionStorage (set by gallery page)
            const storedData = sessionStorage.getItem('affirmationData');
            
            if (!storedData) {
                console.error('âŒ No affirmation data found! Redirecting to gallery...');
                alert('Please start your affirmation journey from the gallery page.');
                window.location.href = 'gallery.html';
                return;
            }
            
            try {
                const data = JSON.parse(storedData);
                console.log('ðŸ“¦ Loaded affirmation data:', data);
                
                window.affirmationState.userResponses = data.responses;
                window.affirmationState.generatedAffirmations = data.affirmations;
                
                // Replace hotspot sounds with generated affirmations
                replaceHotspotSounds(data.affirmations);
                
                // Show ready message
                showReadyMessage();
                
                window.affirmationState.isInitialized = true;
                
            } catch (error) {
                console.error('âŒ Error loading affirmation data:', error);
                alert('Error loading your affirmations. Please try again.');
                window.location.href = 'gallery.html';
            }
        }
        
        // Replace hotspot sounds with generated affirmations
        function replaceHotspotSounds(affirmations) {
            if (!window.app || !window.app.hotspotManager) {
                console.error('âŒ HotspotManager not available');
                return;
            }
            
            const hotspots = window.app.hotspotManager.hotspots;
            console.log(`ðŸŽ¯ Replacing sounds for ${hotspots.length} hotspots with play-twice logic`);
            console.log(`ðŸ“ Affirmations to assign:`, affirmations);
            
            // Initialize play count tracker
            if (!window.affirmationState.playCount) {
                window.affirmationState.playCount = {};
            }
            
            // Replace each hotspot's sound with an affirmation
            hotspots.forEach((hotspot, index) => {
                if (index < affirmations.length && affirmations[index].url) {
                    console.log(`   ðŸ”„ Hotspot ${index}: Original="${hotspot.sound}" â†’ New="${affirmations[index].url}"`);
                    
                    // Store original sound
                    hotspot.originalSound = hotspot.sound;
                    
                    // Replace with affirmation
                    hotspot.sound = affirmations[index].url;
                    hotspot.affirmationText = affirmations[index].text;
                    hotspot.affirmationIndex = index;
                    hotspot.affirmationId = affirmations[index].id;
                    
                    // Initialize play count for this affirmation
                    window.affirmationState.playCount[affirmations[index].id] = 0;
                    
                    console.log(`   âœ… Hotspot ${index + 1}: "${affirmations[index].text.substring(0, 40)}..." [0/2 plays]`);
                } else {
                    console.log(`   âš ï¸ Hotspot ${index}: No affirmation available (index: ${index}, total: ${affirmations.length})`);
                }
            });
            
            console.log('âœ… Hotspot sounds replaced with affirmations (play-twice enabled)');
            console.log('ðŸŽ¯ Final hotspot states:', hotspots.map((h, i) => ({
                index: i,
                sound: h.sound,
                hasAffirmation: !!h.affirmationText
            })));
        }
        
        // Show ready message
        function showReadyMessage() {
            const overlay = document.createElement('div');
            overlay.className = 'affirmation-ready-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
                backdrop-filter: blur(30px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            const { emotionalTone, focusArea } = window.affirmationState.userResponses;
            
            overlay.innerHTML = `
                <div style="text-align: center; max-width: 700px; padding: 3rem;">
                    <div style="font-size: 5rem; margin-bottom: 1.5rem; animation: pulse 2s ease-in-out infinite;">âœ¨</div>
                    <h2 style="font-size: 2.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">
                        Your Journey Awaits
                    </h2>
                    <p style="color: rgba(255, 255, 255, 0.8); font-size: 1.2rem; line-height: 1.6; margin-bottom: 1.5rem;">
                        We've prepared <strong>10 personalized ${emotionalTone} affirmations</strong> focused on <strong>${focusArea}</strong>.
                    </p>
                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem;">
                        Discover the glowing hotspots in this immersive 360Â° experience to hear your unique messages.
                    </p>
                    <button onclick="this.closest('.affirmation-ready-overlay').remove(); document.getElementById('playBtn').click();" 
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 1.25rem 3rem; border-radius: 12px; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);">
                        Begin Journey âœ¨
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            setTimeout(() => overlay.style.opacity = '1', 10);
        }
        
        // Track hotspot discoveries with PLAY-TWICE logic
        if (window.app && window.app.hotspotManager) {
            const originalOnHotspotClick = window.app.hotspotManager.onHotspotClick;
            window.app.hotspotManager.onHotspotClick = function(hotspot) {
                // Check play-twice limit BEFORE playing
                if (hotspot.affirmationId !== undefined) {
                    const playCount = window.affirmationState.playCount[hotspot.affirmationId] || 0;
                    
                    if (playCount >= 2) {
                        console.log(`â­ï¸ Affirmation ${hotspot.affirmationId} already played 2 times - skipping`);
                        
                        // Show message to user
                        const msg = document.createElement('div');
                        msg.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: rgba(255, 100, 100, 0.9);
                            color: white;
                            padding: 1rem 2rem;
                            border-radius: 12px;
                            font-size: 1.1rem;
                            z-index: 9999;
                            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
                        `;
                        msg.textContent = 'This affirmation has already been heard twice âœ¨';
                        document.body.appendChild(msg);
                        setTimeout(() => msg.remove(), 2000);
                        
                        return; // Don't play the sound
                    }
                    
                    // Increment play count
                    window.affirmationState.playCount[hotspot.affirmationId] = playCount + 1;
                    console.log(`â–¶ï¸ Playing affirmation ${hotspot.affirmationId} (${playCount + 1}/2)`);
                }
                
                // Call original handler (this will play the sound)
                if (originalOnHotspotClick) {
                    originalOnHotspotClick.call(this, hotspot);
                }
                
                // Track affirmation collection
                if (hotspot.affirmationIndex !== undefined) {
                    const affirmation = window.affirmationState.generatedAffirmations[hotspot.affirmationIndex];
                    if (affirmation && !window.affirmationState.collectedAffirmations.includes(affirmation)) {
                        window.affirmationState.collectedAffirmations.push(affirmation);
                        const collected = window.affirmationState.collectedAffirmations.length;
                        console.log(`âœ… Collected affirmation ${collected}/10`);
                        
                        // Show affirmation text overlay with play count
                        const playCount = window.affirmationState.playCount[hotspot.affirmationId];
                        showAffirmationOverlay(affirmation.text, playCount);
                        
                        // Check if all collected
                        if (collected === 10) {
                            setTimeout(() => {
                                showExportUI();
                            }, 3000);
                        }
                    } else if (affirmation) {
                        // Show overlay again for repeated play
                        const playCount = window.affirmationState.playCount[hotspot.affirmationId];
                        showAffirmationOverlay(affirmation.text, playCount);
                    }
                }
            };
        }
        
        // Show affirmation text overlay
        function showAffirmationOverlay(text, playCount) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(102, 126, 234, 0.95);
                color: white;
                padding: 1.5rem 2.5rem;
                border-radius: 16px;
                font-size: 1.2rem;
                max-width: 80%;
                text-align: center;
                z-index: 9998;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                animation: slideUpFade 0.5s ease;
            `;
            
            const playStatus = playCount ? ` [${playCount}/2]` : '';
            overlay.innerHTML = `
                <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;">${playStatus}</div>
                <div>"${text}"</div>
            `;
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                overlay.style.transform = 'translateX(-50%) translateY(-20px)';
                overlay.style.transition = 'all 0.5s ease';
                setTimeout(() => overlay.remove(), 500);
            }, 4000);
        }
        
        // Show export UI with instant download (full MP3 already created!)
        function showExportUI() {
            console.log('ðŸŽ‰ All affirmations collected! Preparing export...');
            
            // Get the full audio URL from sessionStorage
            const data = JSON.parse(sessionStorage.getItem('affirmationData'));
            const fullAudioUrl = data.fullAudio.url;
            const duration = data.fullAudio.duration;
            
            // Create export overlay
            const overlay = document.createElement('div');
            overlay.className = 'affirmation-export-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
                backdrop-filter: blur(30px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            overlay.innerHTML = `
                <div style="text-align: center; max-width: 600px; padding: 3rem; background: rgba(255, 255, 255, 0.05); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div style="font-size: 5rem; margin-bottom: 1.5rem;">ðŸŽ‰</div>
                    <h2 style="font-size: 2.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">
                        Journey Complete!
                    </h2>
                    <p style="color: rgba(255, 255, 255, 0.8); font-size: 1.2rem; line-height: 1.6; margin-bottom: 2rem;">
                        You've discovered all <strong>10 affirmations</strong>. Your personalized audio (${Math.floor(duration)}s) is ready to download!
                    </p>
                    
                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 2rem;">
                        <button onclick="downloadFullAudio('${fullAudioUrl}')" 
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 1.25rem 2.5rem; border-radius: 12px; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);">
                            ðŸ’¾ Download My Affirmations
                        </button>
                        <button onclick="window.location.href='gallery.html'" 
                                style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
                            âœ¨ Create New Journey
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            setTimeout(() => overlay.style.opacity = '1', 10);
        }
        
        // Download the full audio MP3 (already generated!)
        function downloadFullAudio(audioUrl) {
            console.log('ðŸ’¾ Downloading full affirmation audio...');
            
            const a = document.createElement('a');
            a.href = audioUrl;
            a.download = `affirmations_${Date.now()}.mp3`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            console.log('âœ… Download initiated!');
        }
        
        // Start initialization when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForApp);
        } else {
            waitForApp();
        }
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('âœ… [PWA] Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.error('âŒ [PWA] Service Worker registration failed:', error);
                    });
            });
        }
    </script>


<div id="performance-monitor" style="position: fixed; top: 80px; right: 20px; background: rgba(0, 0, 0, 0.9); color: rgb(0, 255, 0); font-family: &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 8px 0px 0px 8px; z-index: 10000; min-width: 250px; border-top: 1px solid rgba(0, 255, 0, 0.3); border-bottom: 1px solid rgba(0, 255, 0, 0.3); border-left: 1px solid rgba(0, 255, 0, 0.3); border-image: initial; border-right: none; transition: transform 0.3s;">
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; cursor: pointer;" id="perf-header">
                <span style="font-weight: bold; color: #0ff;">
                    <span id="perf-emoji">ðŸ“Š</span>
                    <span style="transition: opacity 0.3s ease;" id="perf-title"> Performance</span>
                </span>
                <span style="font-size: 18px; transition: transform 0.3s ease;" id="perf-toggle">â—€</span>
            </div>
            <div id="perf-content" style="padding: 0 15px 15px 15px;">
                <canvas id="fps-graph" width="220" height="60" style="display: block; margin-bottom: 10px;"></canvas>
                <div id="perf-stats">
            <div style="color: #ff0;">FPS: 48</div>
            <div>Frame: 20.86ms</div>
            <div>Memory: 35.07 MB</div>
            <div>Draw Calls: 1</div>
            <div>Triangles: 4.7K</div>
            <div>Textures: 6</div>
            <div>Geometries: 6</div>
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,255,0,0.3);">
                <span style="color: #0f0;">âœ… Performance good</span>
            </div>
        </div>
            </div>
        </div><div id="aria-live-region" role="status" aria-live="polite" aria-atomic="true" style="position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;">Now facing North</div><video crossorigin="anonymous" preload="metadata" playsinline="" data-quality="1080p" loop="" src="http://localhost:8000/assets/videos/processed/matrixCaracasSphere_1/matrixCaracasSphere_1_1080p.mp4" style="display: none;"></video><div class="hotspot-discovery-ui" id="hotspot-discovery-ui">ðŸŽµ Hidden Sounds: <span class="discovered-count" id="discovered-count">0</span>/<span class="total-count" id="total-count">10</span></div><button id="pwa-install-btn" style="position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, rgb(102, 126, 234) 0%, rgb(118, 75, 162) 100%); color: white; border: none; padding: 15px 25px; border-radius: 50px; font-size: 14px; font-weight: bold; cursor: pointer; z-index: 10000; box-shadow: rgba(102, 126, 234, 0.4) 0px 4px 15px; animation: 2s ease 0s infinite normal none running pulseInstall;">ðŸ“± Install App</button></body></html>